<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel to HTML Table</title>
    <style>
        #tablesContainer {
            margin-top: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid #000;
            padding: 8px;
            text-align: left;
        }
        textarea {
            width: 100%;
            height: 100%;
            border: none;
            resize: none;
        }
    </style>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/theme.css">
    <link href='https://fonts.googleapis.com/css?family=Anaheim' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container-fluid">
        <div class="container mt-3">
            <div class="row">
                <div class="col-2"></div>
                <div class="col-5">
                    <div class="card">
                        <div class="card-body">
                            <form>
                                <div class="mb-3">
                                    <label for="sub-sl" class="form-label">SUB-SL</label>
                                    <select class="form-select" id="sub-sl" aria-describedby="sub-sl">
                                        <option value="C&I: CDM CIBC">C&I: CDM CIBC</option>
                                        <option value="C&I: CIBC">C&I: CIBC</option>
                                        <option value="C&I: EAO">C&I: EAO</option>
                                        <option value="C&I: Leadership">C&I: Leadership</option>
                                        <option value="C&I: LT & BizOps">C&I: LT & BizOps</option>
                                        <option value="C&I: Network">C&I: Network</option>
                                        <option value="C&I: PM & EAO SDEX">C&I: PM & EAO SDEX</option>
                                        <option value="C&I: PM & PMO">C&I: PM & PMO</option>
                                        <option value="C&I: VPC">C&I: VPC</option>
                                        <option value="CIO: DXC IT">CIO: DXC IT</option>
                                        <option value="Delivery Excellence">Delivery Excellence</option>
                                        <option value="Global Deliver: Region">Global Deliver: Region</option>
                                        <option value="Site Operations">Site Operations</option>
                                      </select>
                                </div>
                                <div class="mb-3">
                                    <label for="team-name" class="form-label">Team Name</label>
                                    <input type="text" class="form-control" id="team-name" aria-describedby="team-name">
                                </div>
                                <div class="mb-3">
                                    <label for="wbs" class="form-label">WBS</label>
                                    <input type="text" class="form-control" id="wbs" aria-describedby="wbs">
                                </div>
                                <div class="mb-3">
                                    <button type="button" class="btn btn-primary float-end" id="checkTeamInfo">Verify</button>
                                    <button type="button" class="btn btn-primary float-end" id="saveTeamInfo">Save</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card">
                        <div class="card-body"></div>
                    </div>
                </div>
                <div class="col-2"></div>
            </div>
        </div>
    </div>
    

    <script>
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        $(document).ready(function() {
            $(document)
            .on('click','#checkTeamInfo',function(){
                checkTeamInfo();
            })
            .on('click','#saveTeamInfo',function(){
                saveTeamInfo();
            });
        });
        
        const dbName = 'sppdata';
        const storeSchemas = [
            { name: 'team-info', keyPath: 'id' },
            { name: 'shift-info', keyPath: 'id' },
            { name: 'team-info', keyPath: 'id' },
            { name: 'rota-info', keyPath: 'id' },
            { name: 'standby-info', keyPath: 'id' },
            { name: 'submission-logs', keyPath: 'id' }
        ];
        function checkDatabaseExists(dbName) {
            return new Promise((resolve, reject) => {
                let request = indexedDB.open(dbName);

                request.onsuccess = function(event) {
                    let db = event.target.result;
                    db.close();
                    resolve(true);
                };

                request.onupgradeneeded = function(event) {
                    event.target.transaction.abort();
                    resolve(false);
                };

                request.onerror = function(event) {
                    reject('Database error: ' + event.target.errorCode);
                };
            });
        }

        function checkTableExists(dbName, storeName) {
            return new Promise((resolve, reject) => {
                let request = indexedDB.open(dbName);

                request.onsuccess = function(event) {
                    let db = event.target.result;
                    let exists = db.objectStoreNames.contains(storeName);
                    resolve(exists);
                };

                request.onerror = function(event) {
                    reject('Database error: ' + event.target.errorCode);
                };
            });
        }

        function createDatabaseAndTable(dbName, storeSchemas) {
            return new Promise((resolve, reject) => {
                let request = indexedDB.open(dbName, 1);

                request.onupgradeneeded = function(event) {
                    let db = event.target.result;
                    storeSchemas.forEach(schema => {
                        if (!db.objectStoreNames.contains(schema.name)) {
                            db.createObjectStore(schema.name, { keyPath: schema.keyPath });
                            console.log(`Object store "${schema.name}" created.`);
                        }
                    });
                };

                request.onsuccess = function(event) {
                    resolve(`Database "${dbName}" and tables created/checked successfully.`);
                };

                request.onerror = function(event) {
                    reject('Database error: ' + event.target.errorCode);
                };
            });
        }

        function checkTeamInfo(){
            let subSl = $('#sub-sl').val();
            let teamName = $('#team-name').val();
            let wbs = $('#wbs').val();
            let teamInfo = {
                "SUBSL": subSl,
                Team: teamName,
                WBS: wbs
            };
            $.ajax({
                //url: 'https://prod-15.westus.logic.azure.com:443/workflows/8c8fc6aef9404f4ba7d7c95234f09ab7/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=wmeO4cY32iIrQBkSv_wavtBPx6OINBJEjvr9Z6T9h9s',
                url: 'https://prod-08.westus.logic.azure.com:443/workflows/474c521d5db942af8e7ada7e224942f0/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=v04lNrvXqT0XCeD952IiA9ts_0wCW0V5Abxoi7xQZX0',
                type: 'POST',
                contentType: "application/json",
                data: JSON.stringify(teamInfo),
                success: function(response) {
                    // Parse the response
                    console.log("Flow triggered successfully! Received response:", response);
                    
                    // Check if response contains the data
                    if (response) {
                        // Access properties of the returned item
                        var subSl = response["SUB_x002d_SL"];
                        var team = response["Team"];
                        var title = response["WBS"]; // Assuming Title is a field in your SharePoint list

                        console.log("SUB-SL:", subSl);
                        console.log("Team:", team);
                    } else {
                        console.log("No item found.");
                    }
                },
                error: function(xhr, status, error) {
                    alert("Error triggering flow: " + xhr.responseText);
                }
            })
        }

        function saveTeamInfo(){
            let subSl = $('#sub-sl').val();
            let teamName = $('#team-name').val();
            let wbs = $('#wbs').val();
            let teamInfo = {
                "SUBSL": subSl,
                Team: teamName,
                WBS: wbs
            };
            $.ajax({
                url: 'https://prod-147.westus.logic.azure.com:443/workflows/22112f3877014f419f86892822cb4481/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=8nDGiXPHXBcLvxG5sdf_w94zNAlYRkwpKpjvK1WK688',
                type: 'POST',
                contentType: "application/json",
                data: JSON.stringify(teamInfo),
                success: function(response) {
                    // Parse the response
                    console.log("Flow triggered successfully! Received response:", response);
                    
                    // Check if response contains the data
                    if (response) {
                        // Access properties of the returned item
                        console.log(response['message']);
                    } else {
                        console.log(response['message']);
                    }
                },
                error: function(xhr, status, error) {
                    alert("Error triggering flow: " + xhr.responseText);
                }
            })
        }
        // Check if database exists and create it if necessary
        checkDatabaseExists(dbName)
            .then(dbExists => {
                if (!dbExists) {
                    return createDatabaseAndTable(dbName, storeSchemas);
                } else {
                    console.log('Database already exists.');
                    // Check and create each table if necessary
                    return Promise.all(storeSchemas.map(schema => {
                        return checkTableExists(dbName, schema.name)
                            .then(tableExists => {
                                if (!tableExists) {
                                    return createDatabaseAndTable(dbName, [schema]);
                                } else {
                                    console.log(`Table "${schema.name}" already exists.`);
                                }
                            });
                    }));
                }
            })
            .then(message => {
                if (message) {
                    console.log(message);
                }
            })
            .catch(error => {
                console.error(error);
            });

        

    </script>
</body>
</html>
