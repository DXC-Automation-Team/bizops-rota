<!doctype html>
<html>
<head>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=EDGE" />
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/theme.css">
    <link href='https://fonts.googleapis.com/css?family=Anaheim' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://alcdn.msauth.net/browser/2.16.1/js/msal-browser.min.js"></script>
    <title>SPP BizOps Rota</title>

</head>
<body>
    <div id="contents">
        <nav class="navbar navbar-expand-lg  bg-dark border-bottom border-body" data-bs-theme="dark">
            <div class="container-fluid">
                <div class="row flex-grow-1">
                    <div class="col-4">
                        <button class="btn btn-outline-light border-0" id="sidebarToggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#references" aria-controls="references">
                            <i class="fa-solid fa-bars"></i>
                        </button>
                    </div>
                    <div class="col-4 text-center" >
                        <span class="navbar-brand" id="page-name"></span>
                    </div>
                    <div class="col-4">
                        <div class="d-flex">
                            <!-- <button class="btn btn-outline-light border-0 ms-auto" type="button" data-bs-toggle="modal" data-bs-target="#uploadModal">
                                <i class="fa-solid fa-file-arrow-up"></i>
                            </button> -->
                            <div class="ms-auto dropstart">
                                <button class="btn btn-outline-light border-0 dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fa-regular fa-circle-user"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li id="signIn"><a class="dropdown-item">Sign In</a></li>
                                    <li id="signOut"><a class="dropdown-item">Sign Out</a></li>
                                    <li id="getAccountInfo"><a class="dropdown-item">Account Info</a></li>
                                </ul>
                            </div>
                            
                        </div>
                        
                    </div>
                </div>
                
            </div>
        </nav>
        <!-- Modals -->
                
            <!-- General Modal -->
            <div class="modal fade" id="generalModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="modal-title"></h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p id="modal-message"></p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Upload Modal -->
            <div class="modal fade" id="uploadModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5">Upload ROTA file</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form>
                                <div class="mb-3">
                                    <label for="rotaFile" class="form-label">Select ROTA file</label>
                                    <input class="form-control" type="file" id="rotaFile" accept=".xlsm, .xlsx">
                                    <div class="upload-text form-text">Please upload the ROTA file to set up the database.</div>
                                    <div class="upload-text form-text d-none">Workbook loaded successfully!</div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" id="extract" disabled>Extract</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            
        <!--/ Modals -->  
        <div class="offcanvas offcanvas-start" tabindex="-1" id="references" aria-labelledby="referencesLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="referencesLabel">References</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <div class="list-group list-group-flush">
                    <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action active"  loaded="true" target="home-page">Home</button>
                    <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action"  loaded="false" target="rotas-page">ROTAs</button>
                    <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action"  loaded="false" target="team-info-page">Team Info</button>
                    <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action"  loaded="false" target="employee-info-page">Employee Info</button>
                    <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action"  loaded="false" target="shift-info-page">Shift Info</button>
                    <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action"  loaded="false" target="PUTIL-target-page">PUTIL Target</button>
                    <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action"  loaded="false" target="SPP-cutoffs-page">SPP Cutoffs</button>
                    <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action"  loaded="false" target="submission-logs-page">Submission Logs</button>
    
                </div>        
            </div>
        </div>
        <div class="container-fluid">
            
            <div class="container mt-3" id="main">
                <div class="page d-flex align-items-center " id="home-page">
                    <div class="row align-items-center h-100 flex-grow-1">  
                        <div class="col-1"></div>
                        <div class="col-1 h-30">
                            <div class="card h-100">
                                <div class="card-body"></div>
                            </div>
                        </div>
                        <div class="col-1 ps-0 h-40">
                            <div class="card h-100">
                                <div class="card-body"></div>
                            </div>
                        </div>
                        <div class="col-2 ps-0 h-60">
                            <div class="card h-100">
                                <div class="card-body"></div>
                            </div>
                        </div>
                        <div class="col-5 px-0 h-75">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex flex-column align-items-center justify-content-center h-100">
                                        <h1>Welcome to the SPP BizOps Rota</h1>
                                        <p>This is a tool to manage the SPP BizOps Rota. Please sign in to access the features.</p>
                                        <!-- <button id="fettch">Fetch Data</button>
                                        <button id="append">Append</button> -->
                                    </div>
                                    
                                    
                                    
                                </div>
                            </div>
                        </div>
                        <div class="col-2">
                        </div>
                    </div> 
                    
                </div>
                <div class="d-none page" id="rotas-page"></div>
                <div class="d-none page" id="team-info-page"></div>
                <div class="d-none page" id="employee-info-page"></div>
                <div class="d-none page" id="shift-info-page"></div>
                <div class="d-none page" id="PUTIL-target-page"></div>
                <div class="d-none page" id="SPP-cutoffs-page"></div>
                <div class="d-none page" id="submission-logs-page"></div>
            </div>
            
        </div>
        
    
        
        
    </div>
    

    <script src="assets/jquery/jquery-3.7.1.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            var workbook; // Variable to store the workbook
            const msalConfig = {
                auth: {
                    clientId: "31badd82-505e-4b39-bed5-efeac69d9158", // Replace with your client ID
                    authority: "https://login.microsoftonline.com/93f33571-550f-43cf-b09f-cd331338d086", // Replace with your tenant ID
                    redirectUri: "https://dxc-automation-team.github.io/bizops-rota/" // Replace with your redirect URI
                }
            };
            const msalInstance = new msal.PublicClientApplication(msalConfig);
            
            var siteId, driveId, tokenResponse;
            var accountName, email;
            init();
            $(document)
            .on('click', '#signIn', function(){
                signIn();
            })
            .on('click', '#signOut', async function(){
                msalInstance.logout();
            })
            .on('click', '#getAccountInfo', function(){
                console.log("Account Name:", accountName);
                console.log("Email:", email);
            })
            .on('click', '#references .list-group-item', function(){
                $('#references .list-group-item').removeClass('active');
                $(this).addClass('active');
                $('#page-name').text($(this).text());
                let page = $(this).attr('target');
                let loaded = $(this).attr('loaded');
                $('#'+page).removeClass('d-none');
                $('.page').not('#'+page).addClass('d-none');
                if (loaded === 'false') {
                    loadContent('#' + page, 'aside/' + page + '.html', function(success) {
                        if (success) {
                            loaded = 'true'; // Update loaded status
                            $(this).attr('loaded', loaded); // Update the attribute

                            if (page === 'rotas-page') {
                                let d = new Date();
                                generateTable(d.getMonth() + 1); // Call generateTable after content is loaded
                            }
                        }
                    });
                } else {
                    if (page === 'rotas-page') {
                        let d = new Date();
                        generateTable(d.getMonth() + 1); // Call generateTable directly if already loaded
                    }
                }
            })
            .on('change', '#rotaFile', function(event){
                $('#extract').prop('disabled', false);
                checkFileInput(event);
            })
            .on('click', '#extract', function(){
                getTableData('Reference', 'tbl_Employee');
                // getNamedRangeData('Sheet1', 'NamedRange1');
            })
            .on('click', '#fettch', function(){
                fetchFileContents('team-info.json')
            })
            .on('click', '#append', function(){
                let data = { data1: 1 };
                appendToFile('team-info.json', data);
                fetchFileContents('team-info.json')
            })

            async function init(){
                checkBrowser();
                checkLoginStatus();
                $('#home-page').css('opacity', '1');
                let d = new Date();
                let dbExists;
                
                
                /* await checkDatabaseExists("sppdata")
                    .then(result => {
                        dbExists = result.exists; // Save the value to the variable
                        if(!dbExists){
                            showModal("Database Status", result.message);
                        }
                    })
                    .catch(error => console.log(error)); */
                // set page text
                setYear(d);
                setActiveRota(d);
                $('#page-name').text($('#references .list-group-item.active').text());

            }
            function setYear(d){
                let year = d.getFullYear();
                $('#year').text(year);
            }
            function setActiveRota(d){
                let month = d.getMonth();
                let rota = '#rota-'+(month+1);
                let link = '#rotas-page .nav-link[aria-controls="rota-'+(month+1)+'"]';
                $('#rotas-page .nav-link').removeClass('active');
                $('#rotas-page .tab-pane').removeClass('show active');
                $(link).addClass('active');
                $(rota).addClass('show active');
            }
            function showModal(title, message){
                $('#modal-title').text(title);
                $('#modal-message').text(message);
                $('#generalModal').modal('show');

            }
            function checkDatabaseExists(dbName) {
                return new Promise((resolve, reject) => {
                    //force users to use edge
                    
                    let request = indexedDB.open(dbName);
                    
                    request.onupgradeneeded = function(event) {
                        request.transaction.abort();
                        resolve({ exists: false, message: "Database not found. Please use Microsoft Edge and set up the required data from the ROTA file." });
                    };

                    request.onsuccess = function(event) {
                        let db = event.target.result;
                        db.close();
                        resolve({ exists: true, message: "Database exists and was opened successfully." });
                    };

                    request.onerror = function(event) {
                        reject({ exists: false, message: `Error opening database: ${event.target.errorCode}` });
                    };
                });
            }
            function checkBrowser(){
                var isEdge = /Edg\/\d./i.test(navigator.userAgent);
                if(!isEdge){
                    $("body").html(`
                        <div class="container-fluid" style="height: 100vh; display: flex; justify-content: center; align-items: center;">
                            <div class="alert alert-danger" role="alert">
                                <h1>Please use Microsoft Edge to access this page.</h1>
                            </div>
                        </div>
                    `)
                }
            }
            function generateTable(month) {
                // Get the number of days in the month
                var daysInMonth = new Date(2025, month, 0).getDate();

                // Create table element
                var table = $('<table>').addClass('table table-striped table-hover table-bordered');

                // Create table header rows
                var thead = $('<thead>');
                var headerRow = $('<tr>');
                var dayOfWeekRow = $('<tr>');
                headerRow.append($('<th>').attr('rowspan', 2).text('Name'));

                for (var day = 1; day <= daysInMonth; day++) {
                    var date = new Date(2025, month - 1, day); // Month is zero-indexed
                    headerRow.append($('<th>').text(('0' + day).slice(-2)).css('white-space', 'nowrap')); // Format day as dd
                    dayOfWeekRow.append($('<th>').text(date.toLocaleDateString('en-US', { weekday: 'short' })).css('white-space', 'nowrap')); // Format day of the week as ddd
                }

                headerRow.append($('<th>').attr('rowspan', 2).text('TEH').css('white-space', 'nowrap'));
                headerRow.append($('<th>').attr('rowspan', 2).text('PUTIL Hours'));
                headerRow.append($('<th>').attr('rowspan', 2).text('PUTIL').css('white-space', 'nowrap'));

                thead.append(headerRow);
                thead.append(dayOfWeekRow);
                table.append(thead);

                // Create table body
                var tbody = $('<tbody>').addClass("table-group-divider");

                // Add dummy data rows
                var dummyData = [
                    { name: "John Doe", TEH: "8", PUTILHours: "5", PUTIL: "10" },
                    { name: "Jane Smith", TEH: "7", PUTILHours: "4", PUTIL: "9" },
                    { name: "Alice Johnson", TEH: "6", PUTILHours: "3", PUTIL: "8" }
                ];

                for (var i = 0; i < dummyData.length; i++) {
                    var dataRow = $('<tr>');
                    var data = dummyData[i];
                    dataRow.append($('<td>').append($('<input>').attr('type', 'text').val(data.name)));
                    for (var day = 1; day <= daysInMonth; day++) {
                        dataRow.append($('<td>').append($('<input>').attr('type', 'text').val('X'))); // Dummy data for days
                    }
                    dataRow.append($('<td>').append($('<input>').attr('type', 'text').val(data.TEH)));
                    dataRow.append($('<td>').append($('<input>').attr('type', 'text').val(data.PUTILHours)));
                    dataRow.append($('<td>').append($('<input>').attr('type', 'text').val(data.PUTIL)));
                    tbody.append(dataRow);
                }

                // Append tbody to the table
                table.append(tbody);

                // Append the table to .tab-pane.fade .card-body
                $('#rota-'+(month)+' .card-body').html(table);
            }
            function loadContent(elementId, filePath, callback) {
                $(elementId).load(filePath, function(response, status, xhr) {
                    if (status == "success") {
                        $(elementId).show(); // Show the content once loaded
                        if (callback) callback(true); // Call the callback function if provided
                    } else if (status == "error") {
                        $(elementId).html("Failed to load content.");
                        if (callback) callback(false); // Call the callback function with failure status
                    }
                });
            }

            async function signIn() {
                await msalInstance.handleRedirectPromise();
                try {
                    const accounts = msalInstance.getAllAccounts();
                    if (accounts.length === 0) {
                        const loginResponse = await msalInstance.loginRedirect({
                            scopes: ["email","openid","profile", "user.read", "Sites.Read.All", "Sites.ReadWrite.All"] // Replace with the necessary scopes
                        });
                        console.log("Login successful:", loginResponse);
                        
                        getAccountInfo();
                    } else {
                        console.log("User already signed in:", accounts[0]);
                        accountName = accounts[0].name;
                        email = accounts[0].username;
                    }
                    
                    siteId, driveId, tokenResponse = await getSiteAndDriveDetails();
                } catch (error) {
                    console.error("Login error:", error);
                    showModal("Login Error", "There was an error signing in. Please refresh the browser and try again.");
                }
            }
            async function getAccountInfo() {
                const token = await getToken();
                if (token) {
                    const profile = await getUserProfile(token);
                    console.log("User Profile:", profile);
                    const accounts = msalInstance.getAllAccounts();
                    accountName = accounts[0].name;
                    email = accounts[0].username;
                }
            }
            async function getUserProfile(accessToken) {
                const graphEndpoint = "https://graph.microsoft.com/v1.0/me";
                try {
                    const response = await fetch(graphEndpoint, {
                        headers: {
                            Authorization: `Bearer ${accessToken}`
                        }
                    });
                    const profile = await response.json();
                    return profile;
                } catch (error) {
                    console.error("Fetching user profile error:", error);
                }
            }
            async function getToken() {
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    const request = {
                        scopes: ["email", "openid", "profile", "user.read", "Sites.Read.All", "Sites.ReadWrite.All"] // Replace with necessary scopes
                    };
                    try {
                        const response = await msalInstance.acquireTokenSilent(request);
                        return response.accessToken;
                    } catch (error) {
                        console.error("Token acquisition error:", error);
                        if (error instanceof msal.InteractionRequiredAuthError) {
                            // Fallback to interactive token acquisition if silent acquisition fails
                            const loginResponse = await msalInstance.loginRedirect(request);
                            return loginResponse.accessToken;
                        } else {
                            throw error;
                        }
                    }
                } else {
                    throw new Error("No accounts found.");
                }
            }
            async function checkLoginStatus() {
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    $('#signIn').hide();
                    $('#signOut, #sidebarToggler, #getAccountInfo').show();
                } else {
                    $('#signIn').show();
                    $('#signOut, #sidebarToggler, #getAccountInfo').hide();
                }
            }




            async function getSiteAndDriveDetails() {
                const account = msalInstance.getAllAccounts()[0];
                tokenResponse = await msalInstance.acquireTokenSilent({
                    scopes: ["Sites.Read.All", "Sites.ReadWrite.All"],
                    account: account
                });

                // Get the Site ID
                const siteResponse = await fetch("https://graph.microsoft.com/v1.0/sites?search=ciROTASchedule", {
                    headers: {
                        Authorization: `Bearer ${tokenResponse.accessToken}`
                    }
                });

                const siteData = await siteResponse.json();
                siteId = siteData.value[0].id;

                // Get the Drive ID for the document library
                const driveResponse = await fetch(`https://graph.microsoft.com/v1.0/sites/${siteId}/drives`, {
                    headers: {
                        Authorization: `Bearer ${tokenResponse.accessToken}`
                    }
                });

                const driveData = await driveResponse.json();
                driveId = driveData.value[0].id; // Assuming the first drive is the document library

                // return { siteId, driveId, tokenResponse };
            }

            async function fetchFileContents(file) {
                try {
                    // const { siteId, driveId, tokenResponse } = await getSiteAndDriveDetails();
                    const filePath = `Development/Data/${file}`;
                    // Get the File ID for the specific file
                    const fileResponse = await fetch(`https://graph.microsoft.com/v1.0/sites/${siteId}/drives/${driveId}/root:/${filePath}`, {
                        headers: {
                            Authorization: `Bearer ${tokenResponse.accessToken}`
                        }
                    });

                    const fileData = await fileResponse.json();
                    const fileId = fileData.id;

                    // Fetch the contents of the file
                    const contentResponse = await fetch(`https://graph.microsoft.com/v1.0/sites/${siteId}/drives/${driveId}/items/${fileId}/content`, {
                        headers: {
                            Authorization: `Bearer ${tokenResponse.accessToken}`
                        }
                    });

                    var fileContents = await contentResponse.text();
                    console.log("File contents:", fileContents);
                    console.log("File type", typeof fileContents);
                    
                    fileContents = JSON.parse(fileContents || "{}");

                    console.log("Parsed File contents:", fileContents);
                    console.log("Parsed File type", typeof fileContents);

                    return fileContents;
                } catch (error) {
                    console.error("Error fetching file contents:", error);
                }
            }

            async function appendToFile(file, dataToAppend) {
                try {
                    var fileContents = await fetchFileContents(file);
                    console.log("data to append", dataToAppend);
                    // Append new data to the JSON object
                    fileContents['property'] = dataToAppend;

                    // Convert JSON back to string
                    const updatedFileContents = JSON.stringify(fileContents, null, 2);

                    // const { siteId, driveId, tokenResponse } = await getSiteAndDriveDetails();
                    const filePath = `Development/Data/${file}`;
                    // Get the File ID for the specific file
                    const fileResponse = await fetch(`https://graph.microsoft.com/v1.0/sites/${siteId}/drives/${driveId}/root:/${filePath}`, {
                        headers: {
                            Authorization: `Bearer ${tokenResponse.accessToken}`
                        }
                    });

                    const fileData = await fileResponse.json();
                    const fileId = fileData.id;

                    // Update the file with the new contents
                    await fetch(`https://graph.microsoft.com/v1.0/sites/${siteId}/drives/${driveId}/items/${fileId}/content`, {
                        method: 'PUT',
                        headers: {
                            Authorization: `Bearer ${tokenResponse.accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: updatedFileContents
                    });

                    console.log("File updated successfully.");
                } catch (error) {
                    console.error("Error appending to file:", error);
                }
            }
        });



    </script>
</body>
</html>