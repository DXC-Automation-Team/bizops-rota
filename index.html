<!doctype html>
<html>
<head>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=EDGE" />
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/theme.css">
    <link href='https://fonts.googleapis.com/css?family=Anaheim' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <title>SPP BizOps Rota</title>

</head>
<body>
    <nav class="navbar navbar-expand-lg  bg-dark border-bottom border-body" data-bs-theme="dark">
        <div class="container-fluid">
            <div class="row flex-grow-1">
                <div class="col-4">
                    <button class="btn btn-outline-light border-0" type="button" data-bs-toggle="offcanvas" data-bs-target="#references" aria-controls="references">
                        <i class="fa-solid fa-bars"></i>
                    </button>
                </div>
                <div class="col-4 text-center" >
                    <span class="navbar-brand" id="page-name"></span>
                </div>
                <div class="col-4">
                    <div class="d-flex">
                        <button class="btn btn-outline-light border-0 ms-auto" type="button" data-bs-toggle="modal" data-bs-target="#uploadModal">
                            <i class="fa-solid fa-file-arrow-up"></i>
                        </button>
                    </div>
                    
                </div>
            </div>
            
        </div>
    </nav>
    <!-- Modals -->
            
        <!-- General Modal -->
        <div class="modal fade" id="generalModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="modal-title"></h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p id="modal-message"></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Upload Modal -->
        <div class="modal fade" id="uploadModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5">Upload ROTA file</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="mb-3">
                                <label for="rotaFile" class="form-label">Select ROTA file</label>
                                <input class="form-control" type="file" id="rotaFile" accept=".xlsm, .xlsx">
                                <div class="upload-text form-text">Please upload the ROTA file to set up the database.</div>
                                <div class="upload-text form-text d-none">Workbook loaded successfully!</div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="extract" disabled>Extract</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        
    <!-- end alerts -->    
    <div class="container-fluid">
        
        <div class="container mt-3" id="main">
            <div class="page" id="rotas-page">
                <h1>For the year <span id="year"></span></h1> 
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" aria-current="page" data-bs-toggle="tab" data-bs-target="#rota-1" role="tab" aria-controls="rota-1" aria-selected="true">January</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" aria-current="page" data-bs-toggle="tab" data-bs-target="#rota-2" role="tab" aria-controls="rota-2" aria-selected="false">February</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" aria-current="page" data-bs-toggle="tab" data-bs-target="#rota-3" role="tab" aria-controls="rota-3" aria-selected="false">March</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" aria-current="page" data-bs-toggle="tab" data-bs-target="#rota-4" role="tab" aria-controls="rota-4" aria-selected="false">April</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" aria-current="page" data-bs-toggle="tab" data-bs-target="#rota-5" role="tab" aria-controls="rota-5" aria-selected="false">May</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" aria-current="page" data-bs-toggle="tab" data-bs-target="#rota-6" role="tab" aria-controls="rota-6" aria-selected="false">June</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" aria-current="page" data-bs-toggle="tab" data-bs-target="#rota-7" role="tab" aria-controls="rota-7" aria-selected="false">July</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" aria-current="page" data-bs-toggle="tab" data-bs-target="#rota-8" role="tab" aria-controls="rota-8" aria-selected="false">August</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" aria-current="page" data-bs-toggle="tab" data-bs-target="#rota-9" role="tab" aria-controls="rota-9" aria-selected="false">September</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" aria-current="page" data-bs-toggle="tab" data-bs-target="#rota-10" role="tab" aria-controls="rota-10" aria-selected="false">October</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" aria-current="page" data-bs-toggle="tab" data-bs-target="#rota-11" role="tab" aria-controls="rota-11" aria-selected="false">November</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" aria-current="page" data-bs-toggle="tab" data-bs-target="#rota-12" role="tab" aria-controls="rota-12" aria-selected="false">December</button>
                    </li>                    
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade" id="rota-1" role="tabpanel" aria-labelledby="rota-1" tabindex="0">
                        <div class="card rotapage">
                            <div class="card-body">
                                
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="rota-2" role="tabpanel" aria-labelledby="rota-2" tabindex="0">
                        <div class="card rotapage">
                            <div class="card-body">
                                
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="rota-3" role="tabpanel" aria-labelledby="rota-3" tabindex="0">
                        <div class="card rotapage">
                            <div class="card-body">
                                
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
            <div class="d-none page" id="team-info-page"></div>
            <div class="d-none page" id="employee-info-page"></div>
            <div class="d-none page" id="shift-info-page"></div>
            <div class="d-none page" id="PUTIL-target-page"></div>
            <div class="d-none page" id="SPP-cutoffs-page"></div>
            <div class="d-none page" id="submission-logs-page"></div>
        </div>
        
    </div>
    

    <div class="offcanvas offcanvas-start" tabindex="-1" id="references" aria-labelledby="referencesLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="referencesLabel">References</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="list-group list-group-flush">
                <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action active"  loaded="true" target="rotas-page">ROTAs</button>
                <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action "  loaded="false" target="team-info-page">Team Info</button>
                <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action "  loaded="false" target="employee-info-page">Employee Info</button>
                <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action "  loaded="false" target="shift-info-page">Shift Info</button>
                <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action "  loaded="false" target="PUTIL-target-page">PUTIL Target</button>
                <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action "  loaded="false" target="SPP-cutoffs-page">SPP Cutoffs</button>
                <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action "  loaded="false" target="submission-logs-page">Submission Logs</button>

            </div>        
        </div>
    </div>

    <button onclick="signIn()">Sign In</button>
    <button onclick="fetchData('team-info.json')">Fetch Data</button>
    <button id="append">Append</button>

    <script src="assets/jquery/jquery-3.7.1.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            var workbook; // Variable to store the workbook
            init();
            $(document)
            .on('click', '#references .list-group-item', function(){
                $('#references .list-group-item').removeClass('active');
                $(this).addClass('active');
                $('#page-name').text($(this).text());
                let page = '#'+$(this).attr('target');
                $(page).removeClass('d-none');
                $('.page').not(page).addClass('d-none');
            })
            .on('change', '#rotaFile', function(event){
                $('#extract').prop('disabled', false);
                checkFileInput(event);
            })
            .on('click', '#extract', function(){
                getTableData('Reference', 'tbl_Employee');
                // getNamedRangeData('Sheet1', 'NamedRange1');
            })
            .on('click', '#references .list-group-item', function(){
                let page = $(this).attr('target');
                if($(this).attr('loaded') == 'false'){
                    loadContent('#'+page, 'aside/'+page+'.html');
                    $(this).attr('loaded', 'true');
                }
            })
            .on('click', '#append', function(){
                let data = { data1: 1 };
                appendToFile('team-info.json', data);
                fetchData('team-info.json')
            })
            async function init(){
                // checkBrowser();
                let d = new Date();
                let dbExists;
                
                
                await checkDatabaseExists("sppdata")
                    .then(result => {
                        dbExists = result.exists; // Save the value to the variable
                        if(!dbExists){
                            showModal("Database Status", result.message);
                        }
                    })
                    .catch(error => console.log(error));
                // set page text
                setYear(d);
                setActiveRota(d);
                $('#page-name').text($('#references .list-group-item.active').text());
                generateTable(d.getMonth()+1);

            }
            function setYear(d){
                let year = d.getFullYear();
                $('#year').text(year);
            }
            function setActiveRota(d){
                let month = d.getMonth();
                let rota = '#rota-'+(month+1);
                let link = '#rotas-page .nav-link[aria-controls="rota-'+(month+1)+'"]';
                $('#rotas-page .nav-link').removeClass('active');
                $('#rotas-page .tab-pane').removeClass('show active');
                $(link).addClass('active');
                $(rota).addClass('show active');
            }
            function showModal(title, message){
                $('#modal-title').text(title);
                $('#modal-message').text(message);
                $('#generalModal').modal('show');

            }
            
            function checkDatabaseExists(dbName) {
                return new Promise((resolve, reject) => {
                    //force users to use edge
                    var isEdge = /Edg\/\d./i.test(navigator.userAgent);
                    if(!isEdge){
                        $("body").html(`
                            <div class="container-fluid" style="height: 100vh; display: flex; justify-content: center; align-items: center;">
                                <div class="alert alert-danger" role="alert">
                                    <h1>Please use Microsoft Edge to access this page.</h1>
                                </div>
                            </div>
                        `)
                    }
                    let request = indexedDB.open(dbName);
                    
                    request.onupgradeneeded = function(event) {
                        request.transaction.abort();
                        resolve({ exists: false, message: "Database not found. Please use Microsoft Edge and set up the required data from the ROTA file." });
                    };

                    request.onsuccess = function(event) {
                        let db = event.target.result;
                        db.close();
                        resolve({ exists: true, message: "Database exists and was opened successfully." });
                    };

                    request.onerror = function(event) {
                        reject({ exists: false, message: `Error opening database: ${event.target.errorCode}` });
                    };
                });
            }
            function generateTable(month) {
                // Get the number of days in the month
                var daysInMonth = new Date(2025, month, 0).getDate();

                // Create table element
                var table = $('<table>').addClass('table table-striped table-hover table-bordered');

                // Create table header rows
                var thead = $('<thead>');
                var headerRow = $('<tr>');
                var dayOfWeekRow = $('<tr>');
                headerRow.append($('<th>').attr('rowspan', 2).text('Name'));

                for (var day = 1; day <= daysInMonth; day++) {
                    var date = new Date(2025, month - 1, day); // Month is zero-indexed
                    headerRow.append($('<th>').text(('0' + day).slice(-2)).css('white-space', 'nowrap')); // Format day as dd
                    dayOfWeekRow.append($('<th>').text(date.toLocaleDateString('en-US', { weekday: 'short' })).css('white-space', 'nowrap')); // Format day of the week as ddd
                }

                headerRow.append($('<th>').attr('rowspan', 2).text('TEH').css('white-space', 'nowrap'));
                headerRow.append($('<th>').attr('rowspan', 2).text('PUTIL Hours'));
                headerRow.append($('<th>').attr('rowspan', 2).text('PUTIL').css('white-space', 'nowrap'));

                thead.append(headerRow);
                thead.append(dayOfWeekRow);
                table.append(thead);

                // Create table body
                var tbody = $('<tbody>').addClass("table-group-divider");

                // Add dummy data rows
                var dummyData = [
                    { name: "John Doe", TEH: "8", PUTILHours: "5", PUTIL: "10" },
                    { name: "Jane Smith", TEH: "7", PUTILHours: "4", PUTIL: "9" },
                    { name: "Alice Johnson", TEH: "6", PUTILHours: "3", PUTIL: "8" }
                ];

                for (var i = 0; i < dummyData.length; i++) {
                    var dataRow = $('<tr>');
                    var data = dummyData[i];
                    dataRow.append($('<td>').append($('<input>').attr('type', 'text').val(data.name)));
                    for (var day = 1; day <= daysInMonth; day++) {
                        dataRow.append($('<td>').append($('<input>').attr('type', 'text').val('X'))); // Dummy data for days
                    }
                    dataRow.append($('<td>').append($('<input>').attr('type', 'text').val(data.TEH)));
                    dataRow.append($('<td>').append($('<input>').attr('type', 'text').val(data.PUTILHours)));
                    dataRow.append($('<td>').append($('<input>').attr('type', 'text').val(data.PUTIL)));
                    tbody.append(dataRow);
                }

                // Append tbody to the table
                table.append(tbody);

                // Append the table to .tab-pane.fade .card-body
                $('#rota-'+(month)+' .card-body').append(table);
            }
            
            function loadContent(elementId, filePath) {
                $(elementId).load(filePath, function(response, status, xhr) {
                    if (status == "success") {
                        $(elementId).show(); // Show the content once loaded
                    } else if (status == "error") {
                        $(elementId).html("Failed to load content.");
                    }
                });
            }
            
        });
    </script>
    <script src="https://alcdn.msauth.net/browser/2.16.1/js/msal-browser.min.js"></script>
    <script>
        const msalConfig = {
            auth: {
                clientId: "31badd82-505e-4b39-bed5-efeac69d9158", // Replace with your client ID
                authority: "https://login.microsoftonline.com/93f33571-550f-43cf-b09f-cd331338d086", // Replace with your tenant ID
                redirectUri: "https://dxc-automation-team.github.io/bizops-rota/" // Replace with your redirect URI
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);

        async function signIn() {
            try {
                const loginResponse = await msalInstance.loginPopup({
                    scopes: ["user.read", "Sites.Read.All", "Sites.ReadWrite.All"] // Replace with the necessary scopes
                });
                console.log("Login successful:", loginResponse);
                fetchData("team-info.json"); // Fetch data after successful login
            } catch (error) {
                console.error("Login error:", error);
            }
        }

        async function getSiteAndDriveDetails() {
            const account = msalInstance.getAllAccounts()[0];
            const tokenResponse = await msalInstance.acquireTokenSilent({
                scopes: ["Sites.Read.All", "Sites.ReadWrite.All"],
                account: account
            });

            // Get the Site ID
            const siteResponse = await fetch("https://graph.microsoft.com/v1.0/sites?search=ciROTASchedule", {
                headers: {
                    Authorization: `Bearer ${tokenResponse.accessToken}`
                }
            });

            const siteData = await siteResponse.json();
            const siteId = siteData.value[0].id;

            // Get the Drive ID for the document library
            const driveResponse = await fetch(`https://graph.microsoft.com/v1.0/sites/${siteId}/drives`, {
                headers: {
                    Authorization: `Bearer ${tokenResponse.accessToken}`
                }
            });

            const driveData = await driveResponse.json();
            const driveId = driveData.value[0].id; // Assuming the first drive is the document library

            return { siteId, driveId, tokenResponse };
        }

        async function fetchFileContents(file) {
            try {
                const { siteId, driveId, tokenResponse } = await getSiteAndDriveDetails();
                const filePath = `Development/Data/${file}`;
                // Get the File ID for the specific file
                const fileResponse = await fetch(`https://graph.microsoft.com/v1.0/sites/${siteId}/drives/${driveId}/root:/${filePath}`, {
                    headers: {
                        Authorization: `Bearer ${tokenResponse.accessToken}`
                    }
                });

                const fileData = await fileResponse.json();
                const fileId = fileData.id;

                // Fetch the contents of the file
                const contentResponse = await fetch(`https://graph.microsoft.com/v1.0/sites/${siteId}/drives/${driveId}/items/${fileId}/content`, {
                    headers: {
                        Authorization: `Bearer ${tokenResponse.accessToken}`
                    }
                });

                const fileContents = await contentResponse.text();
                console.log("File contents:", fileContents);
                return fileContents;
            } catch (error) {
                console.error("Error fetching file contents:", error);
            }
        }

        async function appendToFile(file, dataToAppend) {
            try {
                const fileContents = await fetchFileContents(file);
                let jsonData = JSON.parse(fileContents);

                // Append new data to the JSON object
                jsonData.push(dataToAppend);

                // Convert JSON back to string
                const updatedFileContents = JSON.stringify(jsonData, null, 2);

                const { siteId, driveId, tokenResponse } = await getSiteAndDriveDetails();

                // Get the File ID for the specific file
                const fileResponse = await fetch(`https://graph.microsoft.com/v1.0/sites/${siteId}/drives/${driveId}/root:/${filePath}`, {
                    headers: {
                        Authorization: `Bearer ${tokenResponse.accessToken}`
                    }
                });

                const fileData = await fileResponse.json();
                const fileId = fileData.id;

                // Update the file with the new contents
                await fetch(`https://graph.microsoft.com/v1.0/sites/${siteId}/drives/${driveId}/items/${fileId}/content`, {
                    method: 'PUT',
                    headers: {
                        Authorization: `Bearer ${tokenResponse.accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: updatedFileContents
                });

                console.log("File updated successfully.");
            } catch (error) {
                console.error("Error appending to file:", error);
            }
        }




    </script>
</body>
</html>