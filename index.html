<!doctype html>
<html>
<head>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=EDGE" />
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.2.2/css/dataTables.bootstrap5.css">
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/theme.css">
    <link href='https://fonts.googleapis.com/css?family=Anaheim' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://alcdn.msauth.net/browser/2.16.1/js/msal-browser.min.js"></script>
    <title>SPP BizOps Rota</title>

</head>
<body>
    <div id="contents" class="d-flex flex-column h-100">
        <nav class="navbar navbar-expand-lg  bg-dark border-bottom border-body" data-bs-theme="dark">
            <div class="container-fluid">
                <div class="row flex-grow-1">
                    <div class="col-4">
                        <button class="btn btn-outline-light border-0" id="sidebarToggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#references" aria-controls="references">
                            <i class="fa-solid fa-bars"></i>
                        </button>
                    </div>
                    <div class="col-4 text-center" >
                        <span class="navbar-brand" id="page-name"></span>
                    </div>
                    <div class="col-4">
                        <div class="d-flex">
                            <div class="ms-auto dropstart">
                                <button class="btn btn-outline-light border-0 dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fa-regular fa-circle-user"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li id="signIn"><a class="dropdown-item">Sign In</a></li>
                                    <li id="signOut"><a class="dropdown-item">Sign Out</a></li>
                                    <li id="getAccountInfo"><a class="dropdown-item">Account Info</a></li>
                                </ul>
                            </div>
                            
                        </div>
                        
                    </div>
                </div>
                
            </div>
        </nav>
        <!-- Modals -->
                
            <!-- General Modal -->
            <div class="modal fade" id="generalModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="modal-title"></h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" class="position-relative">
                            <img src="assets/img/robo.svg" alt="" class="position-absolute" id="robot">
                            <p id="modal-message" class="ps-5"></p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Step 1 Modal -->
            <div class="modal fade" id="step1Modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5">Step 1</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            It appears that the database is not set up. Please follow the steps to set up the database.
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary start-step" step="2" data-bs-toggle="modal" data-bs-target="#step2Modal" data-bs-dismiss="modal">Start</button>
                        </div>
                    </div>
                </div>
            </div>
            
            
        <!-- Sidebar -->  
        <div class="offcanvas offcanvas-start" tabindex="-1" id="references" aria-labelledby="referencesLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="referencesLabel">References</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <div class="list-group list-group-flush">
                    <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action active"  loaded="true" target="home-page" id="homeBtn">Home</button>
                    <button type="button" data-bs-dismiss="offcanvas" disabled class="list-group-item list-group-item-action"  loaded="false" target="rotas-page">Shift ROTAs</button>
                    <button type="button" data-bs-dismiss="offcanvas" disabled class="list-group-item list-group-item-action"  loaded="false" target="standby-rotas-page">Standby ROTAs</button>
                    <button type="button" data-bs-dismiss="offcanvas" disabled class="list-group-item list-group-item-action"  loaded="false" target="team-info-page">Team Info</button>
                    <button type="button" data-bs-dismiss="offcanvas" disabled class="list-group-item list-group-item-action"  loaded="false" target="employee-info-page">Employee Info</button>
                    <button type="button" data-bs-dismiss="offcanvas" disabled class="list-group-item list-group-item-action"  loaded="false" target="shift-info-page">Shift Info</button>
                    <button type="button" data-bs-dismiss="offcanvas" disabled class="list-group-item list-group-item-action"  loaded="false" target="PUTIL-target-page">PUTIL Target</button>
                    <button type="button" data-bs-dismiss="offcanvas" disabled class="list-group-item list-group-item-action"  loaded="false" target="SPP-cutoffs-page">SPP Cutoffs</button>
                    <button type="button" data-bs-dismiss="offcanvas" disabled class="list-group-item list-group-item-action"  loaded="false" target="submission-logs-page">Submission Logs</button>
                    <button type="button" data-bs-dismiss="offcanvas" disabled class="list-group-item list-group-item-action"  loaded="false" target="checklist-page">Setup Checklist</button>
                </div>        
            </div>
        </div>
        <div class="container-fluid flex-grow-1">
            
            <div class="container h-100" id="main">
                <div class="page pt-3 d-flex align-items-center " id="home-page">
                    <div class="row align-items-center h-100 flex-grow-1">  
                        <div class="col-1"></div>
                        <div class="col-1 h-30">
                            <div class="card h-100">
                                <div class="card-body"></div>
                            </div>
                        </div>
                        <div class="col-1 ps-0 h-40">
                            <div class="card h-100">
                                <div class="card-body"></div>
                            </div>
                        </div>
                        <div class="col-2 ps-0 h-60">
                            <div class="card h-100">
                                <div class="card-body"></div>
                            </div>
                        </div>
                        <div class="col-5 px-0 h-75">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex flex-column align-items-center justify-content-center h-100">
                                        <h1>Welcome to the SPP BizOps Rota</h1>
                                        <p>This is a tool to manage the SPP BizOps Rota. Please sign in to access the features.</p>
                                        <!-- <button id="fettch">Fetch Data</button>
                                        <button id="append">Append</button> -->
                                    </div>
                                    
                                    
                                    
                                </div>
                            </div>
                        </div>
                        <div class="col-2">
                        </div>
                    </div> 
                
                </div>
                <div class="d-none pt-3 page" id="rotas-page"></div>
                <div class="d-none pt-3 page" id="standby-rotas-page"></div>
                <div class="d-none h-100 page" id="team-info-page"></div>
                <div class="d-none h-100 page" id="employee-info-page"></div>
                <div class="d-none pt-3 h-100 page" id="shift-info-page"></div>
                <div class="d-none pt-3 h-100 page" id="PUTIL-target-page"></div>
                <div class="d-none pt-3 h-100 page" id="SPP-cutoffs-page"></div>
                <div class="d-none pt-3 h-100 page" id="submission-logs-page"></div>
                <div class="d-none pt-3 h-100 page" id="checklist-page"></div>
            </div>
            
        </div>
        
    
        
        
    </div>
    

    <script src="assets/jquery/jquery-3.7.1.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/2.2.2/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.2.2/js/dataTables.bootstrap5.js"></script>
    <script>
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const msalConfig = {
            auth: {
                clientId: "31badd82-505e-4b39-bed5-efeac69d9158", // Replace with your client ID
                authority: "https://login.microsoftonline.com/93f33571-550f-43cf-b09f-cd331338d086", // Replace with your tenant ID
                redirectUri: "https://dxc-automation-team.github.io/bizops-rota/" // Replace with your redirect URI
            }
        };
        const msalInstance = new msal.PublicClientApplication(msalConfig);
        
        var siteId, driveId, tokenResponse;
        var accountName, email;
        var currentYear;
        const dbName = 'sppdata';
        const storeSchemas = [
            { name: 'team-info', keyPath: 'id' },
            { name: 'shift-info', keyPath: 'id' },
            { name: 'employee-info', keyPath: 'id' },
            { name: 'rota-info', keyPath: 'id' },
            { name: 'standby-info', keyPath: 'id' },
            { name: 'submission-logs', keyPath: 'id' }
        ];
        var teamID;
        
        $(document).ready(function() {
            
            init();
            $(document)
            .on('click', '#signIn', function(){
                signIn();
            })
            .on('click', '#signOut', async function(){
                msalInstance.logout();
            })
            .on('click', '#getAccountInfo', function(){
                console.log("Account Name:", accountName);
                console.log("Email:", email);
            })
            .on('click', '#references .list-group-item', function(){
                
                let page = $(this).attr('target');
                let loaded = $(this).attr('loaded');
                let listItem = $(this);
                $('#references .list-group-item').removeClass('active');
                $(this).addClass('active');
                $('#page-name').text($(this).text());
                $('#'+page).removeClass('d-none');
                $('.page').not('#'+page).addClass('d-none');
                if (loaded === 'false') {
                    loadContent('#' + page, 'aside/' + page + '.html', function(success) {
                        if (success) {
                            let attempts = 0;
                            const interval = 150; // 100ms interval
                            const maxAttempts = 5;
                            const checkStatusInterval = setInterval(function() {
                                console.log("Checking page status attempt", attempts);
                                const pageStatus = checkPageStatus(page);
                                if (pageStatus || attempts >= maxAttempts) {
                                    clearInterval(checkStatusInterval);
                                    if (!pageStatus) {
                                        showModal("Error","Failed to load content. Please refresh the page and try again.",'fail');
                                    } else {
                                        loaded = 'true'; // Update loaded status
                                        listItem.attr('loaded', loaded);
                                        fetchPageContents(page);
                                    }
                                }
                                attempts++;
                            }, interval);
                            
                            switch(page){
                                case 'rotas-page': setupRotasPage();
                                break;
                                case 'employee-info-page': setupEmployeesPage();
                                break;
                            }
                            
                        }
                    });
                }
            })
            .on('click','#rota-tabs .nav-link',function(){
                let target = $(this).attr('data-bs-target');
                let month = target.substring(6);
                generateTableHeaders(month,'shift');
            })
            .on('input', '.rotapage textarea', function(){
                generateRotaTableFromInput($(this));
            })
            .on('click', '.start-step', function(){
                let step = $(this).attr('step');
                localStorage.setItem('tutorial', step);
                continueSetup(step);
            })
            .on('click','#showEmployeeTip',function(){
                let html = `
                    <img src="assets/img/tip-employee-info.gif" class="w-100"><br>
                    You can quickly populate the table by <b>copying</b> the contents of your Employee Info table in your template and <b>pasting</b> it on the text field.
                `;
                showModal("Tip", html);
            })
            .on('input','#employeeDataInput textarea', function(){
                console.log('generating employee table')
                generateEmployeeTable($(this).val().trim())
            })
            .on('submit','#employeeForm', async function(e){
                e.preventDefault();
                await filterEmployees();
            })
            .on('click','#resetEmployees',function(){
                $('#employeeDataInput textarea').val('')
                $('#employeeDataInput').removeClass('d-none');
                $('#employeeInfoCard').addClass('d-none');
                resetEmployeeFormValidation();
                
            })
            .on('click','#updateEmployees',function(){
                //call updateEmployees API
            })
            .on('click','#refreshEmployees',async function(){
                spinButton($(this))
                //load from sharepoint
                await getEmployees()
                    .then(employees => {
                        return processEmployees(employees)
                    })
                    .catch(error => {
                        console.error("Error:", error);
                    });
                resetEmployeeFormValidation()
                stopSpinButton($(this),'Reload')
            })
            .on('input','#employeeForm input',function(){
                let source = $('#employeeForm').attr('source');
                if(source == 'sharepoint')
                    $(this).closest('tr').find('.employee-actions').removeClass('d-none')
            })
            

            async function init(){
                
                checkBrowser();
                $('#home-page').css('opacity', '1');
                
                await checkLoginStatus()
                    .then(status => {
                        if(status){
                            getSiteAndDriveDetails();
                            //check if tutorial is finished or not
                            checkTutorialStatus();
                        }
                    })
                let dbExists;
                
                
                await checkDatabaseExists(dbName)
                    .then(dbExists => {
                        if (!dbExists) {
                            return createDatabaseAndTable(dbName, storeSchemas);
                        } else {
                            console.log('Database already exists.');
                            // Check and create each table if necessary
                            return Promise.all(storeSchemas.map(schema => {
                                return checkTableExists(dbName, schema.name)
                                    .then(tableExists => {
                                        if (!tableExists) {
                                            return createDatabaseAndTable(dbName, [schema]);
                                        } else {
                                            console.log(`Table "${schema.name}" already exists.`);
                                        }
                                    });
                            }));
                        }
                    })
                    .then(message => {
                        return getTableContents(dbName, 'team-info');
                    })
                    .then(content => {
                        if (content) {
                            let teamInfo = content[0];
                            if (teamInfo) {
                                $('#sub-sl').val(teamInfo.SUBSL);
                                $('#team-name').val(teamInfo.Team);
                                $('#wbs').val(teamInfo.WBS);
                                teamID = parseInt(teamInfo.id)
                            }
                        } else {
                            console.log('Table team-info is empty.');
                        }
                    })
                    .catch(error => console.log(error));

                
                
                // set page text
                let d = new Date();
                currentYear = d.getFullYear();
                $('#page-name').text($('#references .list-group-item.active').text());

            }
            
            
            

            
        });
        //UTILITIES
        async function fetchPageContents(page){
            console.log("Fetching page contents for", page);
            switch(page){
                case "rotas-page":
                    $('#year').text(currentYear);
                    let d = new Date();
                    let month = d.getMonth()+1;
                    //check if employee info is setup

                    //check if shift info is setup

                    //check if team info is setup

                    //check server if data is available

                    //if data is available

                    //if data does not exist
                    generateTableHeaders(month,'shift');
                    setActiveRota();
                    
                    break;
                case "standby-rotas-page":
                    break;
                case "team-info-page":
                    addFormValidation();
                    await getTableContents(dbName, 'team-info')
                        .then(content => {
                            if (content) {
                                let teamInfo = content[0];
                                if (teamInfo) {
                                    $('#sub-sl').val(teamInfo.SUBSL);
                                    $('#team-name').val(teamInfo.Team);
                                    $('#wbs').val(teamInfo.WBS);
                                }
                            } else {
                                console.log('Table is empty or does not exist.');
                            }
                        })
                        .catch(error => {
                            console.error(error);
                        });
                    break;
                
            }
        }
        function loadContent(elementId, filePath, callback) {
            $(elementId).load(filePath, function(response, status, xhr) {
                if (status == "success") {
                    $(elementId).show(); // Show the content once loaded
                    if (callback) callback(true); // Call the callback function if provided
                } else if (status == "error") {
                    $(elementId).html("Failed to load content.");
                    if (callback) callback(false); // Call the callback function with failure status
                }
            });
        }
        function showModal(title, message, type=''){
            $('#modal-title').text(title);
            $('#modal-message').html(message);
            switch(type){
                case 'success': $('#robot').attr('src','assets/img/robo-success.svg'); break;
                case 'fail': $('#robot').attr('src','assets/img/robo-fail.svg'); break;
                default: $('#robot').attr('src','assets/img/robo.svg'); break;
            }
            $('#generalModal').modal('show');
        }
        function addFormValidation(){
            'use strict'

            // Fetch all the forms we want to apply custom Bootstrap validation styles to
            const forms = document.querySelectorAll('.needs-validation')

            // Loop over them and prevent submission
            Array.from(forms).forEach(form => {
                form.addEventListener('submit', event => {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    }

                    form.classList.add('was-validated')
                }, false)
            })
        }
        function resetFormValidation(form){
            form.removeClass('was-validated');
        }
        function spinButton(button){
            button.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...');
            button.prop('disabled', true);
        }
        function stopSpinButton(button, text){
            button.html(text);
            button.prop('disabled', false);
        }    
        function resetTeamFormValidation(){
            $('#teamForm').removeClass('was-validated');
            $('#checkTeamInfo').removeClass('d-none');
            $('#teamInfoMessage').hide();
            $('#teamChangeButtons, #teamSubmitButtons').addClass('d-none');
        }
        function resetEmployeeFormValidation(){
            $('#employeeForm').removeClass('was-validated');
        }
        function spinButton(button){
            button.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...');
            button.prop('disabled', true);
        }
        function stopSpinButton(button, text){
            button.html(text);
            button.prop('disabled', false);
        }
        function loader(){
            return `
                    <div class="d-flex flex-column flex-grow-1 align-items-center justify-content-center h-100">
                        <p>Fetching data from server...</p>
                        <div class="spinner-border" role="status"></div>
                    </div>`;
        }
        

        
        //DATABASE FUNCTIONS
        function checkDatabaseExists(dbName) {
            return new Promise((resolve, reject) => {
                let request = indexedDB.open(dbName);

                request.onsuccess = function(event) {
                    let db = event.target.result;
                    db.close();
                    resolve(true);
                };

                request.onupgradeneeded = function(event) {
                    event.target.transaction.abort();
                    resolve(false);
                };

                request.onerror = function(event) {
                    reject('Database error: ' + event.target.errorCode);
                };
            });
        }
        function checkTableExists(dbName, storeName) {
            return new Promise((resolve, reject) => {
                let request = indexedDB.open(dbName);

                request.onsuccess = function(event) {
                    let db = event.target.result;
                    let exists = db.objectStoreNames.contains(storeName);
                    resolve(exists);
                };

                request.onerror = function(event) {
                    reject('Database error: ' + event.target.errorCode);
                };
            });
        }
        function getTableContents(dbName, storeName) {
            return new Promise((resolve, reject) => {
                let request = indexedDB.open(dbName);

                request.onsuccess = function(event) {
                    let db = event.target.result;

                    if (db.objectStoreNames.contains(storeName)) {
                        let transaction = db.transaction(storeName, 'readonly');
                        let objectStore = transaction.objectStore(storeName);
                        let content = [];
                        
                        objectStore.openCursor().onsuccess = function(event) {
                            let cursor = event.target.result;
                            if (cursor) {
                                content.push(cursor.value);
                                cursor.continue();
                            } else {
                                resolve(content.length > 0 ? content : null);
                            }
                        };

                        objectStore.openCursor().onerror = function(event) {
                            reject('Cursor error: ' + event.target.errorCode);
                        };
                    } else {
                        resolve(null); // Table doesn't exist
                    }
                };

                request.onerror = function(event) {
                    reject('Database error: ' + event.target.errorCode);
                };
            });
        }
        function getTableContent(dbName, storeName, key) {
            return new Promise((resolve, reject) => {
                let request = indexedDB.open(dbName);

                request.onsuccess = function(event) {
                    let db = event.target.result;

                    if (db.objectStoreNames.contains(storeName)) {
                        let transaction = db.transaction(storeName, 'readonly');
                        let objectStore = transaction.objectStore(storeName);

                        let getRequest = objectStore.get(key);

                        getRequest.onsuccess = function(event) {
                            if (event.target.result) {
                                resolve(event.target.result);
                            } else {
                                resolve(null); // No data found for the given key
                            }
                        };

                        getRequest.onerror = function(event) {
                            reject('Get error: ' + event.target.errorCode);
                        };
                    } else {
                        resolve(null); // Table doesn't exist
                    }
                };

                request.onerror = function(event) {
                    reject('Database error: ' + event.target.errorCode);
                };
            });
        }
        async function saveToLocalDB(dbName, storeName, data) {
            return new Promise((resolve, reject) => {
                let request = indexedDB.open(dbName);

                request.onsuccess = function(event) {
                    let db = event.target.result;

                    if (db.objectStoreNames.contains(storeName)) {
                        let transaction = db.transaction(storeName, 'readwrite');
                        let objectStore = transaction.objectStore(storeName);

                        let addRequest = objectStore.add(data);

                        addRequest.onsuccess = function() {
                            resolve('Data added successfully');
                        };

                        addRequest.onerror = function(event) {
                            reject('Add error: ' + event.target.errorCode);
                        };
                    } else {
                        resolve('Table does not exist');
                    }
                };

                request.onerror = function(event) {
                    reject('Database error: ' + event.target.errorCode);
                };
            });
        }
        function clearTable(dbName, storeName) {
            return new Promise((resolve, reject) => {
                let request = indexedDB.open(dbName);

                request.onsuccess = function(event) {
                    let db = event.target.result;

                    if (db.objectStoreNames.contains(storeName)) {
                        let transaction = db.transaction(storeName, 'readwrite');
                        let objectStore = transaction.objectStore(storeName);

                        let clearRequest = objectStore.clear();

                        clearRequest.onsuccess = function() {
                            resolve('Table contents cleared successfully');
                        };

                        clearRequest.onerror = function(event) {
                            reject('Clear error: ' + event.target.errorCode);
                        };
                    } else {
                        resolve('Table does not exist');
                    }
                };

                request.onerror = function(event) {
                    reject('Database error: ' + event.target.errorCode);
                };
            });
        }
        function createDatabaseAndTable(dbName, storeSchemas) {
            return new Promise((resolve, reject) => {
                let request = indexedDB.open(dbName, 1);

                request.onupgradeneeded = function(event) {
                    let db = event.target.result;
                    storeSchemas.forEach(schema => {
                        if (!db.objectStoreNames.contains(schema.name)) {
                            db.createObjectStore(schema.name, { keyPath: schema.keyPath });
                            console.log(`Object store "${schema.name}" created.`);
                        }
                    });
                };

                request.onsuccess = function(event) {
                    resolve(`Database "${dbName}" and tables created/checked successfully.`);
                };

                request.onerror = function(event) {
                    reject('Database error: ' + event.target.errorCode);
                };
            });
        }
        function getItemByKey(contentArray, key) {
            return contentArray.find(item => item.id === key); // Assuming 'id' is the key path
        }
        
        
        
        //MSAL FUNCTIONS
        async function saveToSharePoint(listName, data) {
            const url = `https://graph.microsoft.com/v1.0/sites/dxcportal.sharepoint.com:/sites/ciROTASchedule:/lists/${listName}/items`;
            const token = await getToken();
            if (token) {
                const response = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ fields: data })
                });

                if (!response.ok) {
                    throw new Error(`Error saving to SharePoint: ${response.statusText}`);
                }

                const result = await response.json();
                console.log("Data saved successfully:", result);
            }
        }
        async function saveToSharePointBatch(listName, dataArray) {
            const url = "https://graph.microsoft.com/v1.0/$batch"; // Graph API batch endpoint
            const token = await getToken();

            if (token) {
                const batchSize = 20; // Maximum requests per batch
                const batches = [];
                let totalEntries = dataArray.length; // Total number of entries to insert
                let successCount = 0; // Counter for entries with 201 status

                // Split dataArray into batches of 20
                for (let i = 0; i < dataArray.length; i += batchSize) {
                    const batch = dataArray.slice(i, i + batchSize);
                    batches.push(batch);
                }

                for (const batch of batches) {
                    const batchRequests = batch.map((item, index) => ({
                        id: `${index + 1}`, // Unique ID for each request
                        method: "POST",
                        url: `/sites/dxcportal.sharepoint.com:/sites/ciROTASchedule:/lists/${listName}/items`,
                        body: { fields: item },
                        headers: {
                            "Content-Type": "application/json"
                        }
                    }));

                    // Prepare batch payload
                    const batchPayload = { requests: batchRequests };

                    // Send batch request
                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${token}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(batchPayload)
                    });

                    if (!response.ok) {
                        console.error(`Error in batch request: ${response.statusText}`);
                    } else {
                        const result = await response.json();

                        // Check individual responses for errors and count successes
                        result.responses.forEach((res) => {
                            if (res.status === 201) {
                                successCount++;
                            } else if (res.status === 400) {
                                console.error(`Error in item ${res.id}: ${res.body.error.message}`);
                            }
                        });
                    }
                }

                // Compare counters and trigger appropriate response
                if (successCount === totalEntries) {
                    showModal("Success", "All entries were saved successfully!","success");
                } else if (successCount > 0) {
                    showModal(
                        "Partial Success",
                        `${successCount} out of ${totalEntries} entries were saved successfully. Check logs for errors.`,
                        'fail'
                    );
                } else {
                    showModal("Error", "No entries were saved. Please check the logs for details.",'fail');
                }
            }
        }
        async function getFromSharePoint(listName, fields, conditions) {
            const url = `https://graph.microsoft.com/v1.0/sites/dxcportal.sharepoint.com:/sites/ciROTASchedule:/lists/${listName}/items`;
            const token = await getToken();

            if (token) {
                try {
                    // Build the query string for filtering conditions
                    let filterQuery = "";
                    if (conditions && conditions.length > 0) {
                        filterQuery = conditions.map(cond => `fields/${cond.field} eq '${cond.value}'`).join(" and ");
                    }

                    // Construct the URL with $expand and $filter
                    let requestUrl = `${url}?$expand=fields`;
                    if (filterQuery) {
                        requestUrl += `&$filter=${filterQuery}`;
                    }

                    // Fetch items from the SharePoint list
                    const response = await fetch(requestUrl, {
                        method: "GET",
                        headers: {
                            "Authorization": `Bearer ${token}`,
                            "Content-Type": "application/json"
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Error fetching from SharePoint: ${response.statusText}`);
                    }

                    const result = await response.json();

                    // Post-process to return only the specified fields
                    const filteredItems = result.value.map(item => {
                        const processedItem = {};
                        fields.forEach(field => {
                            processedItem[field] = item.fields[field]; // Extract only the specified fields
                        });
                        return processedItem;
                    });

                    console.log("Filtered Items:", filteredItems);
                    return filteredItems; // Return the processed items
                } catch (error) {
                    console.error("Error retrieving data from SharePoint:", error);
                    throw error;
                }
            } else {
                throw new Error("Failed to obtain authentication token.");
            }
        }

        async function signIn() {
            try {
                // Handle the redirect after login
                const redirectResponse = await msalInstance.handleRedirectPromise();

                if (redirectResponse) {
                    console.log("Login successful:", redirectResponse);
                    checkLoginStatus(); // Ensure this runs after a successful login
                    return; // Stop further execution after reload
                }

                const accounts = msalInstance.getAllAccounts();
                if (accounts.length === 0) {
                    // Initiate login redirect
                    await msalInstance.loginRedirect({
                        scopes: ["email", "openid", "profile", "user.read", "Sites.Read.All", "Sites.ReadWrite.All"],
                    });
                    checkLoginStatus(); // Ensure this runs after a successful login
                    window.location.reload();
                } else {
                    checkLoginStatus(); // Account already exists
                }
            } catch (error) {
                console.error("Login error:", error);
                showModal("Login Error", "There was an error signing in. Please refresh the browser and try again.", 'fail');
            }
        }

        async function getAccountInfo() {
            const token = await getToken();
            if (token) {
                const profile = await getUserProfile(token);
                console.log("User Profile:", profile);
                const accounts = msalInstance.getAllAccounts();
                accountName = accounts[0].name;
                email = accounts[0].username;
            }
        }
        async function getUserProfile(accessToken) {
            const graphEndpoint = "https://graph.microsoft.com/v1.0/me";
            try {
                const response = await fetch(graphEndpoint, {
                    headers: {
                        Authorization: `Bearer ${accessToken}`
                    }
                });
                const profile = await response.json();
                return profile;
            } catch (error) {
                console.error("Fetching user profile error:", error);
            }
        }
        async function getToken() {
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                const request = {
                    scopes: ["email", "openid", "profile", "user.read", "Sites.Read.All", "Sites.ReadWrite.All"] // Replace with necessary scopes
                };
                try {
                    const response = await msalInstance.acquireTokenSilent(request);
                    return response.accessToken;
                } catch (error) {
                    console.error("Token acquisition error:", error);
                    if (error instanceof msal.InteractionRequiredAuthError) {
                        // Fallback to interactive token acquisition if silent acquisition fails
                        const loginResponse = await msalInstance.loginRedirect(request);
                        return loginResponse.accessToken;
                    } else {
                        throw error;
                    }
                }
            } else {
                throw new Error("No accounts found.");
            }
        }
        async function checkLoginStatus() {
            console.log("Checking login status");
            const redirectResponse = await msalInstance.handleRedirectPromise();

            if (redirectResponse) {
                console.log("Login successful:", redirectResponse);
            }
            const accounts = msalInstance.getAllAccounts();
            console.log("Accounts:", accounts);
            if (accounts.length > 0) {
                msalInstance.setActiveAccount(accounts[0]);
                $('#signIn').hide();
                $('#signOut, #sidebarToggler, #getAccountInfo').show();
                accountName = accounts[0].name;
                email = accounts[0].username;
                return true;
            } else {
                $('#signIn').show();
                $('#signOut, #sidebarToggler, #getAccountInfo').hide();
                return false;
            }
            
                
        }
        async function getSiteAndDriveDetails() {
            console.log("Fetching site and drive details.")
            const account = msalInstance.getAllAccounts()[0];
            tokenResponse = await msalInstance.acquireTokenSilent({
                scopes: ["Sites.Read.All", "Sites.ReadWrite.All"],
                account: account
            });

            // Get the Site ID
            const siteResponse = await fetch("https://graph.microsoft.com/v1.0/sites?search=ciROTASchedule", {
                headers: {
                    Authorization: `Bearer ${tokenResponse.accessToken}`
                }
            });

            const siteData = await siteResponse.json();
            siteId = siteData.value[0].id;

            // Get the Drive ID for the document library
            const driveResponse = await fetch(`https://graph.microsoft.com/v1.0/sites/${siteId}/drives`, {
                headers: {
                    Authorization: `Bearer ${tokenResponse.accessToken}`
                }
            });

            const driveData = await driveResponse.json();
            driveId = driveData.value[0].id; // Assuming the first drive is the document library

            // return { siteId, driveId, tokenResponse };
        }
        
        function checkBrowser(){
            var isEdge = /Edg\/\d./i.test(navigator.userAgent);
            if(!isEdge){
                $("body").html(`
                    <div class="container-fluid" style="height: 100vh; display: flex; justify-content: center; align-items: center;">
                        <div class="alert alert-danger" role="alert">
                            <h1>Please use Microsoft Edge to access this page.</h1>
                        </div>
                    </div>
                `)
            }
        }
        function checkPageStatus(page){
            let pageStatus = false;
            let pageContent = $('#'+page).html();
            if(pageContent.length > 0){
                pageStatus = true;
            }
            return pageStatus;
            
        }
        
        //TUTORIAL FUNCTIONS
        function checkTutorialStatus(){
            console.log("Checking tutorial status");
            let tutorial = localStorage.getItem('tutorial');
            if(tutorial){
                continueSetup(tutorial);
            } else {
                startSetup();
            }
        }
        function startSetup(){
            $('#step1Modal').modal('show');
            localStorage.setItem('tutorial', '1');
            $('#references button[target="team-info-page"]').removeAttr('disabled').removeProp('disabled');
        }
        function continueSetup(step){
            console.log("Continuing setup from step", step);
            switch(step){
                case '1':
                    $('#references .list-group-item-action').not('#homeBtn').attr('disabled',true).prop('disabled',true);
                    $('#references button[target="team-info-page"]').removeAttr('disabled').removeProp('disabled');
                    
                    $('#step1Modal').modal('show');
                    break;
                case '2':
                    $('#references .list-group-item-action').not('#homeBtn').attr('disabled',true).prop('disabled',true);
                    $('#references button[target="team-info-page"]').removeAttr('disabled').removeProp('disabled');
                    showModal('Step 2',`<p>Go to <b>Team Info</b> page on the left sidebar and fill in the required information.</p>`)
                    break;
                case '3':
                    $('#references .list-group-item-action').not('#homeBtn').attr('disabled',true).prop('disabled',true);
                    $('#references button[target="team-info-page"], #references button[target="employee-info-page"]').removeAttr('disabled').removeProp('disabled');
                    showModal('Step 3',`<p>Now that your team is set up, proceed to the <b>Employee Info</b> page and add or view your team members.</p>`)
                    break;
                case '4':
                    $('#references .list-group-item-action').not('#homeBtn').attr('disabled',true).prop('disabled',true);
                    $('#references button[target="team-info-page"], #references button[target="employee-info-page"], #references button[target="shift-info-page"]').removeAttr('disabled').removeProp('disabled');
                    showModal('Step 4',`<p>Great! Now you have team members. Next, you have to set up your shift codes in the <b>Shift Info</b> page.</p>`);
                    break;
            }
        }
        
        

        //EMPLOYEE FUNCTIONS
        async function setupEmployeesPage(){
            $('#employee-info-page .loadingScreen').html(loader()).removeClass('d-none');
            await getEmployees()
                .then(employees => {
                    return processEmployees(employees)
                })
                .catch(error => {
                    console.error("Error:", error);
                });
        }
        async function getEmployees(){
            try {
                if (!teamID || teamID == undefined || teamID == null){
                    const content = await getTableContents(dbName, 'team-info'); // Await the table contents
                    if (content) {
                        const teamInfo = content[0];
                        if (teamInfo) {
                            teamID = parseInt(teamInfo.id);
                        } else {
                            continueSetup('2');
                            return null;
                        }
                    } else {
                    continueSetup('2');
                        return null;
                    }
                }
                const listName = "Employees";
                const fields = ["id", "TeamID", "EID", "Name", "Email"];
                const conditions = [{ field: "TeamID", value: teamID }];

                return getFromSharePoint(listName, fields, conditions);
                    
                
            } catch (error) {
                console.error("Error in getEmployees:", error);
                throw error; // Propagate the error to the caller
            }
        }
        async function processEmployees(response) {

            if (response) {
                if (response.length > 0) {
                    try {
                        loadEmployeeTable(response);

                        // Await clearing the table
                        const message = await clearTable(dbName, 'employee-info');
                        console.log(message);

                        // Loop through each response entry and save to IndexedDB
                        const savePromises = response.map(data => saveToLocalDB(dbName, 'employee-info', data));
                        await Promise.all(savePromises);

                        console.log('All data added successfully!');
                        

                    } catch (error) {
                        console.error('Error processing employees:', error);
                    }
                } else {
                    // Handle empty response case
                    $('#employeeContent').removeClass('d-none');
                    let html = `
                        <img src="assets/img/tip-employee-info.gif" class="w-100"><br>
                        You can quickly populate the table by <b>copying</b> the contents of your Employee Info table in your template and <b>pasting</b> it on the text field.
                    `;
                    showModal("Tip", html);
                    $('#employee-info-page .loadingScreen').empty().addClass('d-none');
                    $('#employeeDataInput').removeClass("d-none");
                }
            }
        }
        //generateEmployeeTable accepts TDV input from the textarea and generates a table
        function generateEmployeeTable(textarea) {
            const input = textarea; // Get the input data
            const rows = input.split('\n'); // Split input into rows (by new line)
            const table = '#employeeForm table';
            const $tbody = $('#employeeForm tbody'); // Get the <tbody> element
            $tbody.empty(); // Clear existing rows

            // Iterate over rows
            rows.forEach(row => {
                const values = row.split('\t'); // Split each row into values (tab-delimited)
                if (values.length === 3) { // Ensure there are 3 columns (Name, Email, EID)
                    const $newRow = $('<tr>'); // Create a new table row
                    $newRow.append(`
                    <td>
                        <input type="text" class="form-control emp-name" value="${(values[0]).trim()}" required>
                        <div class="invalid-feedback">
                        Please provide a name.
                        </div>
                    </td>
                    `);
                    $newRow.append(`
                    <td>
                        <input type="email" class="form-control emp-email" value="${(values[1]).trim()}" required>
                        <div class="invalid-feedback">
                        Please provide a valid email.
                        </div>
                    </td>
                    `);
                    $newRow.append(`
                    <td>
                        <input type="number" class="form-control emp-eid" value="${parseInt((values[2]).trim())}" step="1" min="1" required>
                        <div class="invalid-feedback">
                        Please provide an EID.
                        </div>
                    </td>
                    `);
                    $newRow.append(`
                    <td>
                        <div class="d-none employee-actions">
                            <button class="btn btn-primary employee-update-btn">Update</button>
                        </div> 
                    </td>
                    `);
                    $tbody.append($newRow); // Append the new row to the tbody
                }
            });
            $('#employeeForm').attr('source','excel');
            $('#employeeDataInput, #employee-from-sharepoint-buttons').addClass('d-none');
            $('#employeeInfoCard, #employee-from-excel-buttons').removeClass('d-none');
        }
        //loadEmployeeTable takes an array from the SPP GetEmployees API and generates a table
        function loadEmployeeTable(array){
            const table = '#employeeForm table';
            const $tbody = $('#employeeForm tbody'); // Get the <tbody> element
            $tbody.empty(); // Clear existing rows
            if(array.length>0){
                array.forEach(row=>{
                    const $newRow = $('<tr>');
                    $newRow.append(`
                    <td>
                        <input type="text" class="form-control emp-name" value="${row.Name}" initial="${row.Name}" required>
                        <div class="invalid-feedback">
                        Please provide a name.
                        </div>
                    </td>
                    `);
                    $newRow.append(`
                    <td>
                        <input type="email" class="form-control emp-email" value="${row.Email}" initial="${row.Email}" required>
                        <div class="invalid-feedback">
                        Please provide a valid email.
                        </div>
                    </td>
                    `);
                    $newRow.append(`
                    <td>
                        <input type="number" class="form-control emp-eid" value="${row.EID}" initial="${row.EID}" step="1" min="1" required>
                        <div class="invalid-feedback">
                        Please provide an EID.
                        </div>
                        <input type="hidden" name="id" value="${row.id}">
                        <input type="hidden" name="id" value="${row.TeamID}">
                    </td>
                    `);
                    $tbody.append($newRow);
                });
            }
            $('#employeeForm').attr('source','sharepoint');
            $('#employeeDataInput, #employee-from-excel-buttons, #employee-info-page .loadingScreen').addClass('d-none');
            setTimeout(function(){
                $('#employeeInfoCard, #employeeContent, #employee-from-sharepoint-buttons').removeClass('d-none')
            },100);
            //for team with existing employees, launch step 4 tutorial
            localStorage.setItem('tutorial', '4');
            continueSetup('4');
            
        }
        async function filterEmployees(){
            
            let data = [];
            
            // Loop through each row in the table (tbody)
            $('#employeeForm tbody tr').each(function () {
                const name = ($(this).find('.emp-name').val()).trim(); // Get the value of the name input
                const email = ($(this).find('.emp-email').val()).trim(); // Get the value of the email input
                const eid = parseInt(($(this).find('.emp-eid').val()).trim()); // Get the value of the eid input
                teamID = parseInt(teamID)
                // Add the row's data into the data array
                data.push({
                    Name: name,
                    Email: email,
                    EID: eid,
                    TeamID: teamID
                });
            });
            saveEmployees(data);
            
        }
        
        async function saveEmployees(data){
            spinButton($("#saveEmployees"));
            await saveToSharePointBatch("Employees",data);
            let employees = await getEmployees();
            loadEmployeeTable(employees);
            resetEmployeeFormValidation()
            stopSpinButton($("#saveEmployees"),'Save');

        }
        
        //ROTA FUNCTIONS
        function setupRotasPage(){
            let d = new Date();
            let month = d.getMonth()+1;
            generateTableHeaders(month,'shift'); // Call generateTable after content is loaded
            setActiveRota();
            $('#year').text(currentYear);
        }
        function generateTableHeaders(month,category) {
            // Check if the table is already generated
            if($('#rota-'+month+' table').length > 0) return;
            // Get the number of days in the month
            var daysInMonth = new Date(currentYear, month, 0).getDate();
            var monthName = monthNames[month - 1];
            // Create table element
            var table = $('<table>').addClass('table table-striped table-hover table-bordered');

            // Create table header rows
            var thead = $('<thead>');
            var headerRow = $('<tr>');
            var dayOfWeekRow = $('<tr>');
            headerRow.append($('<th>').attr('rowspan', 2).text('Name'));

            for (var day = 1; day <= daysInMonth; day++) {
                var date = new Date(currentYear, month - 1, day); // Month is zero-indexed
                headerRow.append($('<th>').text(('0' + day).slice(-2)).css('white-space', 'nowrap')); // Format day as dd
                dayOfWeekRow.append($('<th>').text(date.toLocaleDateString('en-US', { weekday: 'short' })).css('white-space', 'nowrap')); // Format day of the week as ddd
            }
            // OPTIONALLY ADD THIS BACK IF NEEDED
            /* headerRow.append($('<th>').attr('rowspan', 2).text('TEH').css('white-space', 'nowrap'));
            headerRow.append($('<th>').attr('rowspan', 2).text('PUTIL Hours'));
            headerRow.append($('<th>').attr('rowspan', 2).text('PUTIL').css('white-space', 'nowrap')); */

            thead.append(headerRow);
            thead.append(dayOfWeekRow);
            table.append(thead);

            // Create table body with a single cell containing the textarea
            var tbody = $('<tbody>').addClass("table-group-divider");
            var dataRow = $('<tr>');
            // ADD +4 to daysInMonth to account for the extra columns. +1 for the name column, +3 for the extra columns
            var textAreaCell = $('<td>').attr('colspan', daysInMonth+1).append(
                $('<textarea>').attr({
                    rows: 10,
                    placeholder: 'Paste your Excel data here',
                    month: monthName.toLowerCase(),
                    monthnumber: month,
                    category: category,
                    style: 'width: 100%;'
                })
            );
            dataRow.append(textAreaCell);
            tbody.append(dataRow);
            table.append(tbody);

            // Append the table to .tab-pane.fade .card-body
            $('#rota-' + month + ' .card-body').html(table);
        }
        function generateRotaTableFromInput(target){ 
            // var monthName = (monthNames[month - 1]).toLowerCase();
            var month = target.attr('monthnumber');
            // Get the number of days in the month
            var daysInMonth = new Date(currentYear, month, 0).getDate();
            const data = target.val().trim(); 
            const rows = data.split('\n').map(row => row.split('\t')); 
            // let html = '<table class="table table-striped table-hover table-bordered">'; 
            let html = '';
            // Generate table rows 
            rows.forEach(row => {
                html += '<tr>'; 
                row.forEach(cell => { html += `<td><input type="text" value="${cell}"></td>`; }); 
                html += '</tr>'; }
            ); 
            // html += '</table>'; 
            target.closest('tbody').html(html); 
        }
        function generateRotaTableFromServer(){
            // Get the data from the server
            // Generate the table
        }
        function setActiveRota(){
            let d = new Date();
            let month = d.getMonth();
            let rota = '#rota-'+(month+1);
            let link = '#rotas-page .nav-link[aria-controls="rota-'+(month+1)+'"]';
            $('#rotas-page .nav-link').removeClass('active').attr('aria-selected', 'false');
            $('#rotas-page .tab-pane').removeClass('show active');
            $(link).addClass('active').attr('aria-selected', 'true');
            $(rota).addClass('show active');
        }
        
        
    </script>
</body>
</html>