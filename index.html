<!doctype html>
<html>
<head>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=EDGE" />
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/theme.css">
    <link href='https://fonts.googleapis.com/css?family=Anaheim' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://alcdn.msauth.net/browser/2.16.1/js/msal-browser.min.js"></script>
    <title>SPP BizOps Rota</title>

</head>
<body>
    <div id="contents" class="d-flex flex-column h-100">
        <nav class="navbar navbar-expand-lg  bg-dark border-bottom border-body" data-bs-theme="dark">
            <div class="container-fluid">
                <div class="row flex-grow-1">
                    <div class="col-4">
                        <button class="btn btn-outline-light border-0" id="sidebarToggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#references" aria-controls="references">
                            <i class="fa-solid fa-bars"></i>
                        </button>
                    </div>
                    <div class="col-4 text-center" >
                        <span class="navbar-brand" id="page-name"></span>
                    </div>
                    <div class="col-4">
                        <div class="d-flex">
                            <!-- <button class="btn btn-outline-light border-0 ms-auto" type="button" data-bs-toggle="modal" data-bs-target="#uploadModal">
                                <i class="fa-solid fa-file-arrow-up"></i>
                            </button> -->
                            <div class="ms-auto dropstart">
                                <button class="btn btn-outline-light border-0 dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fa-regular fa-circle-user"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li id="signIn"><a class="dropdown-item">Sign In</a></li>
                                    <li id="signOut"><a class="dropdown-item">Sign Out</a></li>
                                    <li id="getAccountInfo"><a class="dropdown-item">Account Info</a></li>
                                </ul>
                            </div>
                            
                        </div>
                        
                    </div>
                </div>
                
            </div>
        </nav>
        <!-- Modals -->
                
            <!-- General Modal -->
            <div class="modal fade" id="generalModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="modal-title"></h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" class="position-relative">
                            <img src="assets/img/robo.svg" alt="" class="position-absolute" id="robot">
                            <p id="modal-message" class="ps-5"></p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Step 1 Modal -->
            <div class="modal fade" id="step1Modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5">Step 1</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            It appears that the database is not set up. Please follow the steps to set up the database.
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#step2Modal" data-bs-dismiss="modal">Start</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Step 2 Modal -->
            <div class="modal fade" id="step2Modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5">Step 2</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            Go to <b>Team Info</b>, <b>Employee Info</b>, and <b>Shift Info</b> pages on the left sidebar and fill in the required information.<br>
                            To check your progress, go to the <b>Checklist</b> page.
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" id="startStep2" data-bs-dismiss="modal">Okay</button>
                        </div>
                    </div>
                </div>
            </div>
            
        <!--/ Modals -->  
        <div class="offcanvas offcanvas-start" tabindex="-1" id="references" aria-labelledby="referencesLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="referencesLabel">References</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <div class="list-group list-group-flush">
                    <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action active"  loaded="true" target="home-page">Home</button>
                    <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action"  loaded="false" target="rotas-page">Shift ROTAs</button>
                    <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action"  loaded="false" target="standby-rotas-page">Standby ROTAs</button>
                    <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action"  loaded="false" target="team-info-page">Team Info</button>
                    <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action"  loaded="false" target="employee-info-page">Employee Info</button>
                    <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action"  loaded="false" target="shift-info-page">Shift Info</button>
                    <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action"  loaded="false" target="PUTIL-target-page">PUTIL Target</button>
                    <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action"  loaded="false" target="SPP-cutoffs-page">SPP Cutoffs</button>
                    <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action"  loaded="false" target="submission-logs-page">Submission Logs</button>
                    <button type="button" data-bs-dismiss="offcanvas" class="list-group-item list-group-item-action"  loaded="false" target="checklist-page">Setup Checklist</button>
                </div>        
            </div>
        </div>
        <div class="container-fluid flex-grow-1">
            
            <div class="container h-100" id="main">
                <div class="page pt-3 d-flex align-items-center " id="home-page">
                    <div class="row align-items-center h-100 flex-grow-1">  
                        <div class="col-1"></div>
                        <div class="col-1 h-30">
                            <div class="card h-100">
                                <div class="card-body"></div>
                            </div>
                        </div>
                        <div class="col-1 ps-0 h-40">
                            <div class="card h-100">
                                <div class="card-body"></div>
                            </div>
                        </div>
                        <div class="col-2 ps-0 h-60">
                            <div class="card h-100">
                                <div class="card-body"></div>
                            </div>
                        </div>
                        <div class="col-5 px-0 h-75">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex flex-column align-items-center justify-content-center h-100">
                                        <h1>Welcome to the SPP BizOps Rota</h1>
                                        <p>This is a tool to manage the SPP BizOps Rota. Please sign in to access the features.</p>
                                        <!-- <button id="fettch">Fetch Data</button>
                                        <button id="append">Append</button> -->
                                    </div>
                                    
                                    
                                    
                                </div>
                            </div>
                        </div>
                        <div class="col-2">
                        </div>
                    </div> 
                    <button id="saveUsingMSAL">MSAL Get</button>
                
                </div>
                <div class="d-none pt-3 page" id="rotas-page"></div>
                <div class="d-none pt-3 page" id="standby-rotas-page"></div>
                <div class="d-none h-100 page" id="team-info-page"></div>
                <div class="d-none h-100 page" id="employee-info-page"></div>
                <div class="d-none pt-3 h-100 page" id="shift-info-page"></div>
                <div class="d-none pt-3 h-100 page" id="PUTIL-target-page"></div>
                <div class="d-none pt-3 h-100 page" id="SPP-cutoffs-page"></div>
                <div class="d-none pt-3 h-100 page" id="submission-logs-page"></div>
                <div class="d-none pt-3 h-100 page" id="checklist-page"></div>
            </div>
            
        </div>
        
    
        
        
    </div>
    

    <script src="assets/jquery/jquery-3.7.1.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script>
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const msalConfig = {
            auth: {
                clientId: "31badd82-505e-4b39-bed5-efeac69d9158", // Replace with your client ID
                authority: "https://login.microsoftonline.com/93f33571-550f-43cf-b09f-cd331338d086", // Replace with your tenant ID
                redirectUri: "https://dxc-automation-team.github.io/bizops-rota/" // Replace with your redirect URI
            }
        };
        const msalInstance = new msal.PublicClientApplication(msalConfig);
        
        var siteId, driveId, tokenResponse;
        var accountName, email;
        var currentYear;
        const dbName = 'sppdata';
        const storeSchemas = [
            { name: 'team-info', keyPath: 'id' },
            { name: 'shift-info', keyPath: 'id' },
            { name: 'employee-info', keyPath: 'id' },
            { name: 'rota-info', keyPath: 'id' },
            { name: 'standby-info', keyPath: 'id' },
            { name: 'submission-logs', keyPath: 'id' }
        ];
        var teamID;
        
        $(document).ready(function() {
            
            init();
            $(document)
            .on('click', '#signIn', function(){
                signIn();
            })
            .on('click', '#signOut', async function(){
                msalInstance.logout();
            })
            .on('click', '#getAccountInfo', function(){
                console.log("Account Name:", accountName);
                console.log("Email:", email);
            })
            .on('click', '#references .list-group-item', function(){
                
                let page = $(this).attr('target');
                let loaded = $(this).attr('loaded');
                let listItem = $(this);
                $('#references .list-group-item').removeClass('active');
                $(this).addClass('active');
                $('#page-name').text($(this).text());
                $('#'+page).removeClass('d-none');
                $('.page').not('#'+page).addClass('d-none');
                if (loaded === 'false') {
                    loadContent('#' + page, 'aside/' + page + '.html', function(success) {
                        if (success) {
                            let attempts = 0;
                            const interval = 150; // 100ms interval
                            const maxAttempts = 5;
                            const checkStatusInterval = setInterval(function() {
                                console.log("Checking page status attempt", attempts);
                                const pageStatus = checkPageStatus(page);
                                if (pageStatus || attempts >= maxAttempts) {
                                    clearInterval(checkStatusInterval);
                                    if (!pageStatus) {
                                        showModal("Error","Failed to load content. Please refresh the page and try again.");
                                    } else {
                                        loaded = 'true'; // Update loaded status
                                        listItem.attr('loaded', loaded);
                                        fetchPageContents(page);
                                    }
                                }
                                attempts++;
                            }, interval);
                            

                            if (page === 'rotas-page') {
                                
                                let d = new Date();
                                let month = d.getMonth()+1;
                                generateTableHeaders(month,'shift'); // Call generateTable after content is loaded
                                setActiveRota();
                                $('#year').text(currentYear);

                            }
                        }
                    });
                }
            })
            .on('click','#rota-tabs .nav-link',function(){
                let target = $(this).attr('data-bs-target');
                let month = target.substring(6);
                generateTableHeaders(month,'shift');
            })
            .on('input', '.rotapage textarea', function(){
                generateTableFromInput($(this));
            })
            .on('click', '#startStep2', function(){
                localStorage.setItem('tutorial', '2');
            })
            .on('click','.list-group-item[target="employee-info-page"]', async function(){
                $('#employee-info-page .loadingScreen').html(loader()).removeClass('d-none');


                await getEmployees()
                    .then(employees => {
                        return processEmployees(employees)
                    })
                    .catch(error => {
                        console.error("Error:", error);
                    });
                
            })
            .on('click','#showEmployeeTip',function(){
                let html = `
                    <img src="assets/img/tip-employee-info.gif" class="w-100"><br>
                    You can quickly populate the table by <b>copying</b> the contents of your Employee Info table in your template and <b>pasting</b> it on the text field.
                `;
                showModal("Tip", html);
            })
            .on('input','#employeeDataInput textarea', function(){
                console.log('generating employee table')
                generateEmployeeTable($(this).val().trim())
            })
            .on('submit','#employeeForm', async function(e){
                e.preventDefault();
                await filterEmployees();
            })
            .on('click','#resetEmployees',function(){
                $('#employeeDataInput textarea').val('')
                $('#employeeDataInput').removeClass('d-none');
                $('#employeeInfoCard').addClass('d-none');
                resetEmployeeFormValidation();
                
            })
            .on('click','#updateEmployees',function(){
                //call updateEmployees API
            })
            .on('click','#refreshEmployees',async function(){
                spinButton($(this))
                //load from sharepoint
                await getEmployees()
                    .then(employees => {
                        return processEmployees(employees)
                    })
                    .catch(error => {
                        console.error("Error:", error);
                    });
                resetEmployeeFormValidation()
                stopSpinButton($(this),'Reload')
            })
            .on('input','#employeeForm input',function(){
                let source = $('#employeeForm').attr('source');
                if(source == 'sharepoint')
                    $(this).closest('tr').find('.employee-actions').removeClass('d-none')
            })
            .on('click','#saveUsingMSAL',function(){
                // saveToSharePointBatch('Employees',sampleEmployees)
                const listName = "Employees";
                const fields = ["ID", "TeamID", "EID", "Name", "Email"];
                const conditions = [{ field: "TeamID", value: teamID }];

                getFromSharePoint(listName, fields, conditions)
                    .then(items => {
                        console.log("Fetched Items:", items);
                    })
                    .catch(error => {
                        console.error("Error:", error);
                    });

            })

            async function init(){
                
                checkBrowser();
                checkLoginStatus();
                $('#home-page').css('opacity', '1');
                let dbExists;
                siteId, driveId, tokenResponse = await getSiteAndDriveDetails();
                
                await checkDatabaseExists(dbName)
                    .then(dbExists => {
                        if (!dbExists) {
                            let step = checkTutorialStatus();
                            if(step){
                                continueSetup(step);
                            }else{
                                startSetup();
                            }
                            return createDatabaseAndTable(dbName, storeSchemas);
                        } else {
                            console.log('Database already exists.');
                            // Check and create each table if necessary
                            return Promise.all(storeSchemas.map(schema => {
                                return checkTableExists(dbName, schema.name)
                                    .then(tableExists => {
                                        if (!tableExists) {
                                            return createDatabaseAndTable(dbName, [schema]);
                                        } else {
                                            console.log(`Table "${schema.name}" already exists.`);
                                        }
                                    });
                            }));
                        }
                    })
                    .then(message => {
                        return getTableContents(dbName, 'team-info');
                    })
                    .then(content => {
                        if (content) {
                            let teamInfo = content[0];
                            if (teamInfo) {
                                $('#sub-sl').val(teamInfo.SUBSL);
                                $('#team-name').val(teamInfo.Team);
                                $('#wbs').val(teamInfo.WBS);
                            }
                        } else {
                            console.log('Table is empty or does not exist.');
                        }
                    })
                    .catch(error => console.log(error));
                // set page text
                let d = new Date();
                currentYear = d.getFullYear();
                $('#page-name').text($('#references .list-group-item.active').text());

            }
            
            function setActiveRota(){
                let d = new Date();
                let month = d.getMonth();
                let rota = '#rota-'+(month+1);
                let link = '#rotas-page .nav-link[aria-controls="rota-'+(month+1)+'"]';
                $('#rotas-page .nav-link').removeClass('active').attr('aria-selected', 'false');
                $('#rotas-page .tab-pane').removeClass('show active');
                $(link).addClass('active').attr('aria-selected', 'true');
                $(rota).addClass('show active');
            }
            
            function checkBrowser(){
                var isEdge = /Edg\/\d./i.test(navigator.userAgent);
                if(!isEdge){
                    $("body").html(`
                        <div class="container-fluid" style="height: 100vh; display: flex; justify-content: center; align-items: center;">
                            <div class="alert alert-danger" role="alert">
                                <h1>Please use Microsoft Edge to access this page.</h1>
                            </div>
                        </div>
                    `)
                }
            }
            function checkPageStatus(page){
                let pageStatus = false;
                let pageContent = $('#'+page).html();
                if(pageContent.length > 0){
                    pageStatus = true;
                }
                return pageStatus;
                
            }
            function checkTutorialStatus(){
                console.log("Checking tutorial status");
                let tutorial = localStorage.getItem('tutorial');
                if(tutorial){
                    return tutorial;
                } else {
                    return null;
                }
            }
            function startSetup(){
                $('#step1Modal').modal('show');
                localStorage.setItem('tutorial', '1');
            }
            function continueSetup(step){
                console.log("Continuing setup from step", step);
                switch(step){
                    case '1':
                        $('#step1Modal').modal('show');
                        break;
                    case '2':
                        $('#step2Modal').modal('show');
                        break;
                }
            }


            async function fetchPageContents(page){
                console.log("Fetching page contents for", page);
                switch(page){
                    case "rotas-page":
                        $('#year').text(currentYear);
                        let d = new Date();
                        let month = d.getMonth()+1;
                        //check if employee info is setup

                        //check if shift info is setup

                        //check if team info is setup

                        //check server if data is available

                        //if data is available

                        //if data does not exist
                        generateTableHeaders(month,'shift');
                        setActiveRota();
                        
                        break;
                    case "standby-rotas-page":
                        break;
                    case "team-info-page":
                        addFormValidation();
                        await getTableContents(dbName, 'team-info')
                            .then(content => {
                                if (content) {
                                    let teamInfo = content[0];
                                    if (teamInfo) {
                                        $('#sub-sl').val(teamInfo.SUBSL);
                                        $('#team-name').val(teamInfo.Team);
                                        $('#wbs').val(teamInfo.WBS);
                                    }
                                } else {
                                    console.log('Table is empty or does not exist.');
                                }
                            })
                            .catch(error => {
                                console.error(error);
                            });
                        break;
                    
                }
            }
            
            function generateTableHeaders(month,category) {
                // Check if the table is already generated
                if($('#rota-'+month+' table').length > 0) return;
                // Get the number of days in the month
                var daysInMonth = new Date(currentYear, month, 0).getDate();
                var monthName = monthNames[month - 1];
                // Create table element
                var table = $('<table>').addClass('table table-striped table-hover table-bordered');

                // Create table header rows
                var thead = $('<thead>');
                var headerRow = $('<tr>');
                var dayOfWeekRow = $('<tr>');
                headerRow.append($('<th>').attr('rowspan', 2).text('Name'));

                for (var day = 1; day <= daysInMonth; day++) {
                    var date = new Date(currentYear, month - 1, day); // Month is zero-indexed
                    headerRow.append($('<th>').text(('0' + day).slice(-2)).css('white-space', 'nowrap')); // Format day as dd
                    dayOfWeekRow.append($('<th>').text(date.toLocaleDateString('en-US', { weekday: 'short' })).css('white-space', 'nowrap')); // Format day of the week as ddd
                }
                // OPTIONALLY ADD THIS BACK IF NEEDED
                /* headerRow.append($('<th>').attr('rowspan', 2).text('TEH').css('white-space', 'nowrap'));
                headerRow.append($('<th>').attr('rowspan', 2).text('PUTIL Hours'));
                headerRow.append($('<th>').attr('rowspan', 2).text('PUTIL').css('white-space', 'nowrap')); */

                thead.append(headerRow);
                thead.append(dayOfWeekRow);
                table.append(thead);

                // Create table body with a single cell containing the textarea
                var tbody = $('<tbody>').addClass("table-group-divider");
                var dataRow = $('<tr>');
                // ADD +4 to daysInMonth to account for the extra columns. +1 for the name column, +3 for the extra columns
                var textAreaCell = $('<td>').attr('colspan', daysInMonth+1).append(
                    $('<textarea>').attr({
                        rows: 10,
                        placeholder: 'Paste your Excel data here',
                        month: monthName.toLowerCase(),
                        monthnumber: month,
                        category: category,
                        style: 'width: 100%;'
                    })
                );
                dataRow.append(textAreaCell);
                tbody.append(dataRow);
                table.append(tbody);

                // Append the table to .tab-pane.fade .card-body
                $('#rota-' + month + ' .card-body').html(table);
            }
            function generateTableFromInput(target){ 
                // var monthName = (monthNames[month - 1]).toLowerCase();
                var month = target.attr('monthnumber');
                // Get the number of days in the month
                var daysInMonth = new Date(currentYear, month, 0).getDate();
                const data = target.val().trim(); 
                const rows = data.split('\n').map(row => row.split('\t')); 
                // let html = '<table class="table table-striped table-hover table-bordered">'; 
                let html = '';
                // Generate table rows 
                rows.forEach(row => {
                    html += '<tr>'; 
                    row.forEach(cell => { html += `<td><input type="text" value="${cell}"></td>`; }); 
                    html += '</tr>'; }
                ); 
                // html += '</table>'; 
                target.closest('tbody').html(html); 
            }
            function generateTableFromServer(){
                // Get the data from the server
                // Generate the table
            }
            function loadContent(elementId, filePath, callback) {
                $(elementId).load(filePath, function(response, status, xhr) {
                    if (status == "success") {
                        $(elementId).show(); // Show the content once loaded
                        if (callback) callback(true); // Call the callback function if provided
                    } else if (status == "error") {
                        $(elementId).html("Failed to load content.");
                        if (callback) callback(false); // Call the callback function with failure status
                    }
                });
            }
            

            
        });
        //UTILITIES
        function showModal(title, message){
            $('#modal-title').text(title);
            $('#modal-message').html(message);
            $('#generalModal').modal('show');

        }
        function addFormValidation(){
            'use strict'

            // Fetch all the forms we want to apply custom Bootstrap validation styles to
            const forms = document.querySelectorAll('.needs-validation')

            // Loop over them and prevent submission
            Array.from(forms).forEach(form => {
                form.addEventListener('submit', event => {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    }

                    form.classList.add('was-validated')
                }, false)
            })
        }
        function resetFormValidation(form){
            form.removeClass('was-validated');
        }
        function spinButton(button){
            button.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...');
            button.prop('disabled', true);
        }
        function stopSpinButton(button, text){
            button.html(text);
            button.prop('disabled', false);
        }    
        function resetTeamFormValidation(){
            $('#teamForm').removeClass('was-validated');
            $('#checkTeamInfo').removeClass('d-none');
            $('#teamInfoMessage').hide();
            $('#teamChangeButtons, #teamSubmitButtons').addClass('d-none');
        }
        function resetEmployeeFormValidation(){
            $('#employeeForm').removeClass('was-validated');
        }
        function spinButton(button){
            button.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...');
            button.prop('disabled', true);
        }
        function stopSpinButton(button, text){
            button.html(text);
            button.prop('disabled', false);
        }
        function loader(){
            return `
                    <div class="d-flex flex-column flex-grow-1 align-items-center justify-content-center h-100">
                        <p>Fetching data from server...</p>
                        <div class="spinner-border" role="status"></div>
                    </div>`;
        }

        
        //DATABASE FUNCTIONS
        function checkDatabaseExists(dbName) {
            return new Promise((resolve, reject) => {
                let request = indexedDB.open(dbName);

                request.onsuccess = function(event) {
                    let db = event.target.result;
                    db.close();
                    resolve(true);
                };

                request.onupgradeneeded = function(event) {
                    event.target.transaction.abort();
                    resolve(false);
                };

                request.onerror = function(event) {
                    reject('Database error: ' + event.target.errorCode);
                };
            });
        }
        function checkTableExists(dbName, storeName) {
            return new Promise((resolve, reject) => {
                let request = indexedDB.open(dbName);

                request.onsuccess = function(event) {
                    let db = event.target.result;
                    let exists = db.objectStoreNames.contains(storeName);
                    resolve(exists);
                };

                request.onerror = function(event) {
                    reject('Database error: ' + event.target.errorCode);
                };
            });
        }
        function getTableContents(dbName, storeName) {
            return new Promise((resolve, reject) => {
                let request = indexedDB.open(dbName);

                request.onsuccess = function(event) {
                    let db = event.target.result;

                    if (db.objectStoreNames.contains(storeName)) {
                        let transaction = db.transaction(storeName, 'readonly');
                        let objectStore = transaction.objectStore(storeName);
                        let content = [];
                        
                        objectStore.openCursor().onsuccess = function(event) {
                            let cursor = event.target.result;
                            if (cursor) {
                                content.push(cursor.value);
                                cursor.continue();
                            } else {
                                resolve(content.length > 0 ? content : null);
                            }
                        };

                        objectStore.openCursor().onerror = function(event) {
                            reject('Cursor error: ' + event.target.errorCode);
                        };
                    } else {
                        resolve(null); // Table doesn't exist
                    }
                };

                request.onerror = function(event) {
                    reject('Database error: ' + event.target.errorCode);
                };
            });
        }
        function getTableContent(dbName, storeName, key) {
            return new Promise((resolve, reject) => {
                let request = indexedDB.open(dbName);

                request.onsuccess = function(event) {
                    let db = event.target.result;

                    if (db.objectStoreNames.contains(storeName)) {
                        let transaction = db.transaction(storeName, 'readonly');
                        let objectStore = transaction.objectStore(storeName);

                        let getRequest = objectStore.get(key);

                        getRequest.onsuccess = function(event) {
                            if (event.target.result) {
                                resolve(event.target.result);
                            } else {
                                resolve(null); // No data found for the given key
                            }
                        };

                        getRequest.onerror = function(event) {
                            reject('Get error: ' + event.target.errorCode);
                        };
                    } else {
                        resolve(null); // Table doesn't exist
                    }
                };

                request.onerror = function(event) {
                    reject('Database error: ' + event.target.errorCode);
                };
            });
        }
        async function saveToLocalDB(dbName, storeName, data) {
            return new Promise((resolve, reject) => {
                let request = indexedDB.open(dbName);

                request.onsuccess = function(event) {
                    let db = event.target.result;

                    if (db.objectStoreNames.contains(storeName)) {
                        let transaction = db.transaction(storeName, 'readwrite');
                        let objectStore = transaction.objectStore(storeName);

                        let addRequest = objectStore.add(data);

                        addRequest.onsuccess = function() {
                            resolve('Data added successfully');
                        };

                        addRequest.onerror = function(event) {
                            reject('Add error: ' + event.target.errorCode);
                        };
                    } else {
                        resolve('Table does not exist');
                    }
                };

                request.onerror = function(event) {
                    reject('Database error: ' + event.target.errorCode);
                };
            });
        }
        function clearTable(dbName, storeName) {
            return new Promise((resolve, reject) => {
                let request = indexedDB.open(dbName);

                request.onsuccess = function(event) {
                    let db = event.target.result;

                    if (db.objectStoreNames.contains(storeName)) {
                        let transaction = db.transaction(storeName, 'readwrite');
                        let objectStore = transaction.objectStore(storeName);

                        let clearRequest = objectStore.clear();

                        clearRequest.onsuccess = function() {
                            resolve('Table contents cleared successfully');
                        };

                        clearRequest.onerror = function(event) {
                            reject('Clear error: ' + event.target.errorCode);
                        };
                    } else {
                        resolve('Table does not exist');
                    }
                };

                request.onerror = function(event) {
                    reject('Database error: ' + event.target.errorCode);
                };
            });
        }
        function createDatabaseAndTable(dbName, storeSchemas) {
            return new Promise((resolve, reject) => {
                let request = indexedDB.open(dbName, 1);

                request.onupgradeneeded = function(event) {
                    let db = event.target.result;
                    storeSchemas.forEach(schema => {
                        if (!db.objectStoreNames.contains(schema.name)) {
                            db.createObjectStore(schema.name, { keyPath: schema.keyPath });
                            console.log(`Object store "${schema.name}" created.`);
                        }
                    });
                };

                request.onsuccess = function(event) {
                    resolve(`Database "${dbName}" and tables created/checked successfully.`);
                };

                request.onerror = function(event) {
                    reject('Database error: ' + event.target.errorCode);
                };
            });
        }
        function getItemByKey(contentArray, key) {
            return contentArray.find(item => item.id === key); // Assuming 'id' is the key path
        }
        
        
        
        //MSAL FUNCTIONS
        async function saveToSharePoint(listName, data) {
            const url = `https://graph.microsoft.com/v1.0/sites/dxcportal.sharepoint.com:/sites/ciROTASchedule:/lists/${listName}/items`;
            const token = await getToken();
            if (token) {
                const response = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ fields: data })
                });

                if (!response.ok) {
                    throw new Error(`Error saving to SharePoint: ${response.statusText}`);
                }

                const result = await response.json();
                console.log("Data saved successfully:", result);
            }
        }
        async function saveToSharePointBatch(listName, dataArray) {
            const url = "https://graph.microsoft.com/v1.0/$batch"; // Graph API batch endpoint
            const token = await getToken();

            if (token) {
                const batchSize = 20; // Maximum requests per batch
                const batches = [];

                // Split dataArray into batches of 20
                for (let i = 0; i < dataArray.length; i += batchSize) {
                    const batch = dataArray.slice(i, i + batchSize);
                    batches.push(batch);
                }

                for (const batch of batches) {
                    const batchRequests = batch.map((item, index) => {
                        return {
                            id: `${index + 1}`, // Unique ID for each request
                            method: "POST",
                            url: `/sites/dxcportal.sharepoint.com:/sites/ciROTASchedule:/lists/${listName}/items`,
                            body: { fields: item },
                            headers: {
                                "Content-Type": "application/json"
                            }
                        };
                    });

                    // Prepare batch payload
                    const batchPayload = { requests: batchRequests };

                    // Send batch request
                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${token}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(batchPayload)
                    });

                    if (!response.ok) {
                        console.error(`Error in batch request: ${response.statusText}`);
                    } else {
                        const result = await response.json();
                        showModal("Success",`Data saved successfully`)
                    }
                }
            }
        }
        async function getFromSharePoint(listName, fields, conditions) {
            const url = `https://graph.microsoft.com/v1.0/sites/dxcportal.sharepoint.com:/sites/ciROTASchedule:/lists/${listName}/items`; // Graph API endpoint for list items
            const token = await getToken();

            if (token) {
                try {
                    // Build the query string for filtering conditions
                    let filterQuery = "";
                    if (conditions && conditions.length > 0) {
                        filterQuery = conditions.map(cond => `${cond.field} eq '${cond.value}'`).join(" and ");
                    }

                    // Add the select (fields) and filter queries to the URL
                    let requestUrl = url;
                    if (fields && fields.length > 0) {
                        requestUrl += `?$select=${fields.join(",")}`;
                    }
                    if (filterQuery) {
                        requestUrl += `&$filter=${filterQuery}`;
                    }

                    // Fetch the items from the list
                    const response = await fetch(requestUrl, {
                        method: "GET",
                        headers: {
                            "Authorization": `Bearer ${token}`,
                            "Content-Type": "application/json"
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Error fetching from SharePoint: ${response.statusText}`);
                    }

                    const result = await response.json();
                    console.log("Items fetched successfully:", result.value);
                    return result.value; // Return the list of items
                } catch (error) {
                    console.error("Error retrieving data from SharePoint:", error);
                }
            } else {
                throw new Error("Failed to obtain authentication token.");
            }
        }

        async function signIn() {
            await msalInstance.handleRedirectPromise();
            try {
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length === 0) {
                    const loginResponse = await msalInstance.loginRedirect({
                        scopes: ["email","openid","profile", "user.read", "Sites.Read.All", "Sites.ReadWrite.All"] // Replace with the necessary scopes
                    });
                    console.log("Login successful:", loginResponse);
                    
                    getAccountInfo();
                }
                location.reload(true);
            } catch (error) {
                console.error("Login error:", error);
                showModal("Login Error", "There was an error signing in. Please refresh the browser and try again.");
            }
        }
        async function getAccountInfo() {
            const token = await getToken();
            if (token) {
                const profile = await getUserProfile(token);
                console.log("User Profile:", profile);
                const accounts = msalInstance.getAllAccounts();
                accountName = accounts[0].name;
                email = accounts[0].username;
            }
        }
        async function getUserProfile(accessToken) {
            const graphEndpoint = "https://graph.microsoft.com/v1.0/me";
            try {
                const response = await fetch(graphEndpoint, {
                    headers: {
                        Authorization: `Bearer ${accessToken}`
                    }
                });
                const profile = await response.json();
                return profile;
            } catch (error) {
                console.error("Fetching user profile error:", error);
            }
        }
        async function getToken() {
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                const request = {
                    scopes: ["email", "openid", "profile", "user.read", "Sites.Read.All", "Sites.ReadWrite.All"] // Replace with necessary scopes
                };
                try {
                    const response = await msalInstance.acquireTokenSilent(request);
                    return response.accessToken;
                } catch (error) {
                    console.error("Token acquisition error:", error);
                    if (error instanceof msal.InteractionRequiredAuthError) {
                        // Fallback to interactive token acquisition if silent acquisition fails
                        const loginResponse = await msalInstance.loginRedirect(request);
                        return loginResponse.accessToken;
                    } else {
                        throw error;
                    }
                }
            } else {
                throw new Error("No accounts found.");
            }
        }
        async function checkLoginStatus() {
            console.log("Checking login status");
            const accounts = msalInstance.getAllAccounts();
            console.log("Accounts:", accounts);
            if (accounts.length > 0) {
                msalInstance.setActiveAccount(accounts[0]);
                $('#signIn').hide();
                $('#signOut, #sidebarToggler, #getAccountInfo').show();
                accountName = accounts[0].name;
                email = accounts[0].username;
            } else {
                $('#signIn').show();
                $('#signOut, #sidebarToggler, #getAccountInfo').hide();
            }
            
                
        }
        async function getSiteAndDriveDetails() {
            const account = msalInstance.getAllAccounts()[0];
            tokenResponse = await msalInstance.acquireTokenSilent({
                scopes: ["Sites.Read.All", "Sites.ReadWrite.All"],
                account: account
            });

            // Get the Site ID
            const siteResponse = await fetch("https://graph.microsoft.com/v1.0/sites?search=ciROTASchedule", {
                headers: {
                    Authorization: `Bearer ${tokenResponse.accessToken}`
                }
            });

            const siteData = await siteResponse.json();
            siteId = siteData.value[0].id;

            // Get the Drive ID for the document library
            const driveResponse = await fetch(`https://graph.microsoft.com/v1.0/sites/${siteId}/drives`, {
                headers: {
                    Authorization: `Bearer ${tokenResponse.accessToken}`
                }
            });

            const driveData = await driveResponse.json();
            driveId = driveData.value[0].id; // Assuming the first drive is the document library

            // return { siteId, driveId, tokenResponse };
        }
        
    </script>
</body>
</html>